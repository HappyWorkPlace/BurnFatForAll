<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NMB HappyWorkPlace - ‡∏Å‡∏¥‡∏ô‡∏î‡∏µ Healthy Life#2</title>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src='https://kit.fontawesome.com/a076d05399.js' crossorigin='anonymous'></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
/* =================================
   üé® CSS VARIABLES & DESIGN TOKENS
   ================================= */
:root {
    /* üé® Colors */
    --primary-500: #10b981;
    --primary-600: #059669;
    --primary-700: #047857;
    
    --secondary-50: #f8fafc;
    --secondary-100: #f1f5f9;
    --secondary-200: #e2e8f0;
    --secondary-300: #cbd5e1;
    --secondary-400: #94a3b8;
    --secondary-500: #64748b;
    --secondary-600: #475569;
    --secondary-700: #334155;
    --secondary-800: #1e293b;
    
    --success-400: #4ade80;
    --success-500: #22c55e;
    --warning-400: #fbbf24;
    --warning-500: #f59e0b;
    --error-400: #f87171;
    --error-500: #ef4444;
    
    --white: #ffffff;
    --black: #000000;
    
    /* üìè Spacing */
    --space-xs: 4px;
    --space-sm: 8px;
    --space-md: 12px;
    --space-lg: 16px;
    --space-xl: 20px;
    --space-2xl: 24px;
    --space-3xl: 32px;
    --space-4xl: 40px;
    
    /* üî§ Typography */
    --text-xs: 0.65rem;
    --text-sm: 0.75rem;
    --text-base: 0.9rem;
    --text-lg: 1rem;
    --text-xl: 1.1rem;
    --text-2xl: 1.2rem;
    --text-3xl: 2rem;
    --text-4xl: 2.4rem;
    
    --font-light: 300;
    --font-normal: 400;
    --font-medium: 500;
    --font-semibold: 600;
    --font-bold: 700;
    
    /* üéØ Border Radius */
    --radius-sm: 8px;
    --radius-md: 12px;
    --radius-lg: 16px;
    --radius-xl: 20px;
    --radius-2xl: 24px;
    --radius-full: 50%;
    
    /* üåä Shadows */
    --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.04);
    --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.05);
    --shadow-lg: 0 8px 25px rgba(0, 0, 0, 0.1);
    --shadow-xl: 0 12px 40px rgba(0, 0, 0, 0.1);
    
    /* üé≠ Gradients */
    --gradient-primary: linear-gradient(135deg, var(--primary-500), var(--primary-600));
    --gradient-bg: linear-gradient(135deg, var(--secondary-50) 0%, var(--secondary-200) 100%);
    --gradient-card: linear-gradient(135deg, var(--white), var(--secondary-50));
    
    /* üì± Container */
    --container-max: 420px;
    --container-padding: var(--space-lg);
}

/* =================================
   üîß RESET & BASE STYLES
   ================================= */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Prompt', sans-serif;
    background: var(--gradient-bg);
    min-height: 100vh;
    color: var(--secondary-800);
    overflow-x: hidden;
    font-size: var(--text-base);
    line-height: 1.5;
}

/* =================================
   üì± LAYOUT COMPONENTS
   ================================= */

/* App Container */
.app-container {
    max-width: var(--container-max);
    margin: 0 auto;
    background: var(--white);
    min-height: 100vh;
    box-shadow: var(--shadow-xl);
    position: relative;
}

/* Header */
.header {
    background: var(--gradient-primary);
    color: var(--white);
    padding: var(--space-sm) var(--space-xs) var(--space-xs);
    text-align: left;
    position: relative;
}

.logo-section {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-xl);
    margin-bottom: var(--space-sm);
}

.logo {
    width: 120px;
    height: 120px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.logo img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: var(--radius-md);
}

.header-text h1 {
    font-size: var(--text-xl);
    font-weight: var(--font-semibold);
    margin-bottom: var(--space-xs);
}

.header-text p {
    font-size: var(--text-sm);
    opacity: 0.9;
    margin-bottom: var(--space-xs);
}

/* Content Areas */
.content {
    padding: 0 var(--container-padding) var(--space-3xl);
}

.nav-container {
    padding: 0 var(--space-xl);
    margin-bottom: var(--space-2xl);
}

/* =================================
   üé¥ CARD COMPONENTS
   ================================= */

/* Points Card */
.points-card {
    background: var(--gradient-card);
    margin: var(--space-lg);
    padding: var(--space-2xl) var(--space-lg);
    border-radius: var(--radius-2xl);
    box-shadow: var(--shadow-xl);
    border: 1px solid var(--secondary-200);
    position: relative;
    overflow: hidden;
}

.points-card::before {
    content: '';
    position: absolute;
    top: 0;
    right: 0;
    width: 100px;
    height: 100px;
    background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(5, 150, 105, 0.05));
    border-radius: 0 0 0 100px;
}

.card-top-section {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-xl);
    position: relative;
    z-index: 1;
}

/* Member Info */
.member-header {
    display: flex;
    align-items: center;
    gap: var(--space-md);
}

.profile-avatar {
    width: 80px;
    height: 80px;
    border-radius: var(--radius-lg);
    background: var(--gradient-primary);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--white);
    font-size: var(--text-xl);
    box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
    border: 3px solid var(--white);
    overflow: hidden;
}

.profile-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: var(--radius-sm);
}

.member-info {
    flex: 1;
}

.member-name {
    font-size: var(--text-base);
    font-weight: var(--font-semibold);
    color: var(--secondary-800);
    margin-bottom: var(--space-xs);
}

.member-dept {
    font-size: var(--text-sm);
    color: var(--secondary-500);
    margin-bottom: var(--space-xs);
}

.member-badge {
    display: inline-block;
    background: var(--gradient-primary);
    color: var(--white);
    padding: var(--space-xs) var(--space-md);
    border-radius: var(--space-sm);
    font-size: var(--text-xs);
    font-weight: var(--font-semibold);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* Points Display */
.points-section {
    text-align: right;
}

.points-value {
    font-size: var(--text-3xl);
    font-weight: var(--font-bold);
    background: var(--gradient-primary);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: var(--space-xs);
    line-height: 1;
}

.points-label {
    font-size: var(--text-sm);
    color: var(--secondary-500);
    font-weight: var(--font-medium);
}

/* =================================
   üéØ PROGRESS & MILESTONES
   ================================= */

.progress-section {
    position: relative;
    margin-top: var(--space-md);
}

.milestones-progress {
    position: relative;
    padding: 0;
}

.progress-track {
    height: 6px;
    background: var(--secondary-100);
    border-radius: var(--radius-md);
    position: absolute;
    top: 31%;
    left: var(--space-md);
    right: var(--space-md);
    transform: translateY(-50%);
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--primary-500), #34d399);
    border-radius: var(--radius-md);
    transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
}

.progress-fill::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
    animation: shimmer 2s infinite;
}

.milestones {
    position: relative;
    padding: 0;
    height: 60px;
}

.milestone {
    position: absolute;
    display: flex;
    flex-direction: column;
    align-items: center;
    z-index: 2;
    transform: translateX(-50%);
}

.milestone:nth-child(1) { left: 19%; }
.milestone:nth-child(2) { left: 39%; }
.milestone:nth-child(3) { left: 59%; }
.milestone:nth-child(4) { left: 79%; }
.milestone:nth-child(5) { left: 95%; }

.milestone-dot {
    width: 28px;
    height: 28px;
    border-radius: var(--radius-full);
    background: var(--secondary-200);
    border: 3px solid var(--white);
    box-shadow: var(--shadow-md);
    margin-bottom: var(--space-sm);
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: var(--text-sm);
}

.milestone.achieved .milestone-dot {
    background: var(--primary-500);
    box-shadow: 0 2px 12px rgba(16, 185, 129, 0.4);
    color: var(--white);
}

.milestone.current .milestone-dot {
    background: var(--warning-500);
    box-shadow: 0 2px 12px rgba(245, 158, 11, 0.4);
    animation: pulse 2s infinite;
    color: var(--white);
}

.milestone-icon {
    display: block;
    color: var(--white);
}

.milestone-label {
    font-size: var(--text-sm);
    color: var(--secondary-500);
    font-weight: var(--font-medium);
    background: var(--white);
    padding: var(--space-xs) var(--space-sm);
    border-radius: var(--radius-sm);
    box-shadow: var(--shadow-sm);
}

.milestone.achieved .milestone-label {
    color: var(--primary-500);
    font-weight: var(--font-semibold);
}

.milestone.current .milestone-label {
    color: var(--warning-500);
    font-weight: var(--font-semibold);
}

/* =================================
   üé† CAROUSEL COMPONENTS
   ================================= */

.gifts-carousel {
    margin-top: var(--space-xs);
}

.gifts-container {
    display: flex;
    overflow-x: auto;
    scroll-behavior: smooth;
    -webkit-overflow-scrolling: touch;
    scroll-snap-type: x mandatory;
    gap: 0;
    /* ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏•‡∏≤‡∏¢ items */
    flex-wrap: nowrap;
}

.gifts-container::-webkit-scrollbar {
    height: 4px;
}

.gifts-container::-webkit-scrollbar-track {
    background: var(--secondary-100);
    border-radius: var(--space-xs);
}

.gifts-container::-webkit-scrollbar-thumb {
    background: var(--secondary-300);
    border-radius: var(--space-xs);
}

.gifts-container::-webkit-scrollbar-thumb:hover {
    background: var(--secondary-400);
}

.gift-slide {
    flex-shrink: 0;
    width: 100%; /* ‡πÅ‡∏ï‡πà‡∏•‡∏∞ slide ‡πÄ‡∏ï‡πá‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á */
    min-width: 100%; /* ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡πá‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á */
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: var(--space-lg) var(--space-md);
    scroll-snap-align: start;
    background: transparent;
    box-sizing: border-box;
}

.gift-content {
    display: flex;
    align-items: center;
    gap: var(--space-lg);
    flex: 1;
    max-width: calc(100% - 90px); /* ‡πÄ‡∏ß‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏° */
}

.gift-icon-large {
    width: 64px;
    height: 64px;
    border-radius: var(--radius-lg);
    background: rgba(16, 185, 129, 0.1);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: var(--text-2xl);
    border: 2px solid rgba(16, 185, 129, 0.2);
    flex-shrink: 0;
}

.gift-icon-large img {
    width: 48px;
    height: 48px;
    object-fit: contain;
}

.gift-details {
    flex: 1;
    min-width: 0; /* ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô overflow */
}

.gift-name-large {
    font-weight: var(--font-semibold);
    font-size: var(--text-lg);
    color: var(--secondary-800);
    margin-bottom: var(--space-sm);
    line-height: 1.3;
    /* ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ */
    overflow: hidden;
    text-overflow: ellipsis;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
}

.gift-points-large {
    font-size: var(--text-base);
    color: var(--primary-500);
    font-weight: var(--font-semibold);
    margin-bottom: var(--space-xs);
}

.gift-stock-large {
    font-size: var(--text-sm);
    color: var(--secondary-500);
}

.gift-action {
    flex-shrink: 0;
    margin-left: var(--space-md);
}

/* Carousel Indicators */
.carousel-indicators {
    display: flex;
    justify-content: center;
    gap: var(--space-sm);
    margin: var(--space-lg) 0;
}

.indicator-dot {
    width: 6px;
    height: 6px;
    border-radius: var(--radius-full);
    background: var(--secondary-300);
    cursor: pointer;
    transition: all 0.3s ease;
}

.indicator-dot.active {
    background: var(--primary-500);
    transform: scale(1.2);
}

/* =================================
   üîò BUTTON COMPONENTS
   ================================= */

/* Base Button Styles */
.btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-sm);
    padding: var(--space-md) var(--space-xl);
    border: none;
    border-radius: var(--radius-lg);
    font-family: 'Prompt', sans-serif;
    font-weight: var(--font-semibold);
    font-size: var(--text-sm);
    cursor: pointer;
    transition: all 0.3s ease;
    text-decoration: none;
    white-space: nowrap;
    min-height: 44px; /* Touch target */
}

/* Primary Button */
.btn-primary {
    background: var(--gradient-primary);
    color: var(--white);
    box-shadow: var(--shadow-md);
}

.btn-primary:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
}

.btn-primary:disabled {
    background: var(--secondary-200);
    color: var(--secondary-400);
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
}

/* Gift Buttons */
.gift-button-large {
    padding: var(--space-md) var(--space-xl);
    background: var(--gradient-primary);
    color: var(--white);
    border: none;
    border-radius: var(--radius-lg);
    font-weight: var(--font-semibold);
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: var(--text-sm);
    font-family: 'Prompt', sans-serif;
    white-space: nowrap;
    min-width: 70px;
    min-height: 40px;
}

.gift-button-large:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
}

.gift-button-large:disabled {
    background: var(--secondary-200);
    color: var(--secondary-400);
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
}

/* Button States */
.btn-available {
    background: var(--gradient-primary) !important;
    color: var(--white) !important;
}

.btn-disabled {
    background: var(--secondary-400) !important;
    color: var(--secondary-500) !important;
    opacity: 0.8 !important;
}

.btn-redeemed {
    background: var(--secondary-500) !important;
    color: var(--secondary-100) !important;
    opacity: 0.9 !important;
}

.btn-outofstock {
    background: var(--error-500) !important;
    color: var(--white) !important;
    opacity: 0.8 !important;
}

/* Record Button */
.record-button {
    width: 100%;
    padding: var(--space-lg);
    background: var(--gradient-primary);
    color: var(--white);
    border: none;
    border-radius: var(--radius-lg);
    font-size: var(--text-lg);
    font-weight: var(--font-semibold);
    cursor: pointer;
    transition: all 0.3s ease;
    margin-top: var(--space-md);
    font-family: 'Prompt', sans-serif;
    min-height: 56px;
}

.record-button:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
}

.record-button:disabled {
    background: var(--secondary-200);
    color: var(--secondary-400);
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
}

/* =================================
   üì± NAVIGATION
   ================================= */

.nav-tabs {
    display: flex;
    background: var(--secondary-50);
    border-radius: var(--radius-lg);
    padding: var(--space-sm);
    border: 1px solid var(--secondary-200);
}

.nav-tab {
    flex: 1;
    padding: var(--space-md) var(--space-sm);
    text-align: center;
    border-radius: var(--radius-md);
    font-size: var(--text-base);
    font-weight: var(--font-medium);
    cursor: pointer;
    transition: all 0.2s ease;
    background: transparent;
    border: none;
    color: var(--secondary-500);
    min-height: 52px;
}

.nav-tab.active {
    background: var(--white);
    color: var(--primary-500);
    box-shadow: var(--shadow-sm);
    font-weight: var(--font-semibold);
}

.nav-tab i {
    display: block;
    font-size: var(--text-xl);
    margin-bottom: var(--space-xs);
}

/* =================================
   üìù FORM COMPONENTS
   ================================= */

.search-container {
    position: relative;
    margin-bottom: var(--space-xl);
}

.search-input {
    width: 100%;
    padding: var(--space-lg) var(--space-xl) var(--space-lg) 50px;
    border: 2px solid var(--secondary-200);
    border-radius: var(--radius-lg);
    font-size: var(--text-lg);
    background: var(--white);
    transition: all 0.3s ease;
    font-family: 'Prompt', sans-serif;
    min-height: 56px;
}

.search-input:focus {
    outline: none;
    border-color: var(--primary-500);
    box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
}

.search-icon {
    position: absolute;
    left: 18px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--secondary-400);
    font-size: var(--text-xl);
}

/* Validation States */
.valid-food {
    border-color: var(--success-500) !important;
    background: rgba(34, 197, 94, 0.05) !important;
    box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.1) !important;
}

.invalid-food {
    border-color: var(--error-500) !important;
    background: rgba(239, 68, 68, 0.05) !important;
    box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1) !important;
}

.validation-status {
    font-size: var(--text-xs);
    margin-top: var(--space-sm);
    transition: all 0.3s ease;
    min-height: 16px;
}

/* Dropdown */
.dropdown-list {
    position: absolute;
    top: calc(100% + var(--space-sm));
    left: 0;
    right: 0;
    background: var(--white);
    border-radius: var(--radius-lg);
    border: 1px solid var(--secondary-200);
    box-shadow: var(--shadow-xl);
    max-height: 240px;
    overflow-y: auto;
    z-index: 100;
    display: none;
}

.dropdown-item {
    padding: var(--space-lg) var(--space-xl);
    cursor: pointer;
    transition: background 0.2s ease;
    border-bottom: 1px solid var(--secondary-100);
}

.dropdown-item:hover {
    background: var(--secondary-50);
}

.dropdown-item:last-child {
    border-bottom: none;
}

/* =================================
   üìã CONTENT SECTIONS
   ================================= */

.section {
    display: none;
}

.section.active {
    display: block;
    animation: fadeIn 0.3s ease;
}

/* History */
.history-item {
    background: var(--white);
    padding: var(--space-lg) var(--space-xl);
    border-radius: var(--radius-lg);
    margin-bottom: var(--space-lg);
    border: 1px solid var(--secondary-100);
    box-shadow: var(--shadow-sm);
    border-left: 4px solid var(--primary-500);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.history-item:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
    border-left-color: var(--primary-600);
}

.history-item::before {
    content: '';
    position: absolute;
    top: 0;
    right: 0;
    width: 60px;
    height: 60px;
    background: linear-gradient(135deg, rgba(16, 185, 129, 0.05), rgba(5, 150, 105, 0.02));
    border-radius: 0 0 0 60px;
}

.history-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: var(--space-xl);
    padding-bottom: var(--space-md);
    border-bottom: 2px solid var(--secondary-100);
}

.history-title {
    font-size: var(--text-xl);
    font-weight: var(--font-semibold);
    color: var(--secondary-800);
    display: flex;
    align-items: center;
    gap: var(--space-md);
}

.history-title i {
    color: var(--primary-500);
    font-size: var(--text-2xl);
}

.history-count {
    background: var(--gradient-primary);
    color: var(--white);
    padding: var(--space-xs) var(--space-md);
    border-radius: var(--radius-full);
    font-size: var(--text-sm);
    font-weight: var(--font-semibold);
    min-width: 24px;
    text-align: center;
}

.history-date {
    font-size: var(--text-sm);
    color: var(--secondary-500);
    margin-bottom: var(--space-sm);
    font-weight: var(--font-medium);
    display: flex;
    align-items: center;
    gap: var(--space-sm);
}

.history-date i {
    color: var(--primary-500);
    font-size: var(--text-sm);
}

.history-food {
    font-weight: var(--font-semibold);
    color: var(--secondary-800);
    font-size: var(--text-lg);
    display: flex;
    align-items: center;
    gap: var(--space-md);
}

.history-food::before {
    content: 'üçΩÔ∏è';
    font-size: var(--text-xl);
}

/* Pagination Styles */
.pagination-container {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: var(--space-lg);
    margin-top: var(--space-2xl);
    padding: var(--space-xl) 0;
    border-top: 1px solid var(--secondary-100);
    background: linear-gradient(135deg, var(--secondary-50), var(--white));
    border-radius: var(--radius-lg);
    position: relative;
}

.pagination-container::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, rgba(16, 185, 129, 0.02), rgba(5, 150, 105, 0.01));
    border-radius: var(--radius-lg);
    z-index: -1;
}

.pagination-btn {
    padding: var(--space-md) var(--space-xl);
    background: var(--gradient-primary);
    color: var(--white);
    border: none;
    border-radius: var(--radius-lg);
    cursor: pointer;
    font-size: var(--text-base);
    font-weight: var(--font-semibold);
    font-family: 'Prompt', sans-serif;
    transition: all 0.3s ease;
    box-shadow: var(--shadow-sm);
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    min-width: 120px;
    justify-content: center;
}

.pagination-btn:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
    background: linear-gradient(135deg, var(--primary-600), var(--primary-700));
}

.pagination-btn:active {
    transform: translateY(0);
    box-shadow: var(--shadow-sm);
}

.pagination-btn i {
    font-size: var(--text-sm);
}

.pagination-info {
    font-size: var(--text-base);
    color: var(--secondary-600);
    font-weight: var(--font-semibold);
    background: var(--white);
    padding: var(--space-md) var(--space-xl);
    border-radius: var(--radius-lg);
    border: 2px solid var(--secondary-100);
    box-shadow: var(--shadow-sm);
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    min-width: 140px;
    justify-content: center;
}

.pagination-info::before {
    content: 'üìÑ';
    font-size: var(--text-lg);
}

/* Empty & Error States */
.empty-history, .error-history {
    min-height: 300px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, var(--secondary-50), var(--white));
    border-radius: var(--radius-xl);
    margin: var(--space-xl) 0;
    border: 1px solid var(--secondary-100);
}

.empty-state-content, .error-state-content {
    text-align: center;
    padding: var(--space-4xl) var(--space-xl);
    color: var(--secondary-500);
    max-width: 320px;
}

.empty-state-content .icon, .error-state-content .icon {
    font-size: 4rem;
    margin-bottom: var(--space-xl);
    opacity: 0.6;
    display: block;
    animation: float 3s ease-in-out infinite;
}

.empty-state-content h3, .error-state-content h3 {
    font-size: var(--text-xl);
    font-weight: var(--font-semibold);
    color: var(--secondary-700);
    margin-bottom: var(--space-md);
}

.empty-state-content p, .error-state-content p {
    font-size: var(--text-base);
    color: var(--secondary-500);
    margin-bottom: var(--space-lg);
    line-height: 1.6;
}

.retry-btn {
    padding: var(--space-md) var(--space-xl);
    background: var(--gradient-primary);
    color: var(--white);
    border: none;
    border-radius: var(--radius-lg);
    cursor: pointer;
    font-size: var(--text-base);
    font-weight: var(--font-semibold);
    font-family: 'Prompt', sans-serif;
    transition: all 0.3s ease;
    box-shadow: var(--shadow-sm);
    display: inline-flex;
    align-items: center;
    gap: var(--space-sm);
}

.retry-btn:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
}

.retry-btn i {
    font-size: var(--text-sm);
}

/* Loading Animation */
.history-loading {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: var(--space-4xl);
    background: linear-gradient(135deg, var(--secondary-50), var(--white));
    border-radius: var(--radius-xl);
    margin: var(--space-xl) 0;
    border: 1px solid var(--secondary-100);
}

.history-loading .spinner {
    width: 48px;
    height: 48px;
    border: 4px solid var(--secondary-100);
    border-top: 4px solid var(--primary-500);
    border-radius: var(--radius-full);
    animation: spin 1s linear infinite;
    margin-bottom: var(--space-xl);
}

.history-loading p {
    font-size: var(--text-lg);
    color: var(--secondary-600);
    font-weight: var(--font-medium);
}

/* Animations */
@keyframes float {
    0%, 100% { transform: translateY(0px); }
    50% { transform: translateY(-10px); }
}

/* Responsive */
@media (max-width: 480px) {
    .pagination-container {
        flex-direction: column;
        gap: var(--space-md);
        padding: var(--space-lg);
    }
    
    .pagination-btn {
        width: 100%;
        max-width: 200px;
        padding: var(--space-lg) var(--space-xl);
        font-size: var(--text-lg);
    }
    
    .pagination-info {
        order: -1;
        margin-bottom: var(--space-sm);
        width: 100%;
        max-width: 200px;
    }
    
    .history-item {
        padding: var(--space-lg) var(--space-md);
        margin-bottom: var(--space-md);
    }
    
    .history-header {
        flex-direction: column;
        align-items: flex-start;
        gap: var(--space-md);
    }
    
    .history-title {
        font-size: var(--text-lg);
    }
    
    .history-food {
        font-size: var(--text-base);
    }
}

/* =================================
   üí´ LOADING & STATES
   ================================= */

.loading-screen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: var(--gradient-primary);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    color: var(--white);
}

.loading-image img {
    border-radius: 10%;
    animation: bounce 2s infinite;
    position: relative;
    left: -20px;
}

.loading-text {
    font-size: var(--text-2xl);
    font-weight: var(--font-medium);
    text-align: center;
}

.loading, .empty-state {
    text-align: center;
    padding: var(--space-4xl) var(--space-xl);
    color: var(--secondary-500);
}

.spinner {
    width: 36px;
    height: 36px;
    border: 3px solid var(--secondary-100);
    border-top: 3px solid var(--primary-500);
    border-radius: var(--radius-full);
    animation: spin 1s linear infinite;
    margin: 0 auto var(--space-lg);
}

.empty-state i {
    font-size: 2.5rem;
    margin-bottom: var(--space-lg);
    opacity: 0.4;
}

/* Highlight */
.highlight {
    background: linear-gradient(135deg, var(--warning-400), var(--warning-500));
    color: #92400e;
    padding: var(--space-xs) var(--space-xs);
    border-radius: var(--space-xs);
    font-weight: var(--font-bold);
    text-shadow: 0 1px 2px rgba(146, 64, 14, 0.1);
    box-shadow: 0 1px 3px rgba(251, 191, 36, 0.3);
}

/* =================================
   üé≠ ANIMATIONS
   ================================= */

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

@keyframes bounce {
    0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
    40% { transform: translateY(-10px); }
    60% { transform: translateY(-5px); }
}

@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.2); }
}

@keyframes shimmer {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* =================================
   üì± RESPONSIVE - TABLET & DESKTOP
   (Mobile-first approach)
   ================================= */

/* Tablet: 768px+ */
@media (min-width: 768px) {
    :root {
        --text-base: 1rem;
        --text-lg: 1.125rem;
        --text-xl: 1.25rem;
        --text-2xl: 1.5rem;
        --text-3xl: 2.25rem;
        --text-4xl: 2.75rem;
        --container-padding: var(--space-xl);
    }
    
    .logo {
        width: 140px;
        height: 140px;
    }
    
    .header-text h1 {
        font-size: var(--text-2xl);
    }
    
    .header-text p {
        font-size: var(--text-base);
    }
    
    .points-card {
        margin: var(--space-xl) var(--space-xl);
        padding: var(--space-3xl) var(--space-2xl);
    }
    
    .profile-avatar {
        width: 90px;
        height: 90px;
        font-size: var(--text-2xl);
    }
    
    .gift-slide {
        padding: var(--space-xl) var(--space-lg);
    }
    
    .gift-content {
        gap: var(--space-2xl);
    }
    
    .gift-icon-large {
        width: 80px;
        height: 80px;
        font-size: var(--text-3xl);
    }
    
    .gift-icon-large img {
        width: 56px;
        height: 56px;
    }
    
    .gift-name-large {
        font-size: var(--text-xl);
    }
    
    .gift-points-large {
        font-size: var(--text-lg);
    }
    
    .gift-button-large {
        padding: var(--space-lg) var(--space-2xl);
        font-size: var(--text-base);
        min-width: 100px;
        min-height: 48px;
    }
    
    .milestone-dot {
        width: 32px;
        height: 32px;
        font-size: var(--text-base);
    }
    
    .carousel-indicators {
        margin: var(--space-xl) 0;
    }
    
    .indicator-dot {
        width: 8px;
        height: 8px;
    }
}

/* Desktop: 1024px+ */
@media (min-width: 1024px) {
    .app-container {
        box-shadow: var(--shadow-xl);
    }
    
    .gift-slide {
        padding: var(--space-lg);
    }
    
    .gift-content {
        gap: var(--space-2xl);
    }
}

/* =================================
   üîß UTILITY CLASSES
   ================================= */

.sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
}

.text-center { text-align: center; }
.text-left { text-align: left; }
.text-right { text-align: right; }

.font-bold { font-weight: var(--font-bold); }
.font-semibold { font-weight: var(--font-semibold); }
.font-medium { font-weight: var(--font-medium); }

.text-primary { color: var(--primary-500); }
.text-secondary { color: var(--secondary-500); }
.text-success { color: var(--success-500); }
.text-warning { color: var(--warning-500); }
.text-error { color: var(--error-500); }

.hidden { display: none; }
.block { display: block; }
.flex { display: flex; }
.inline-flex { display: inline-flex; }

.items-center { align-items: center; }
.justify-center { justify-content: center; }
.justify-between { justify-content: space-between; }

.w-full { width: 100%; }
.h-full { height: 100%; }

.mb-2 { margin-bottom: var(--space-sm); }
.mb-4 { margin-bottom: var(--space-lg); }
.mt-2 { margin-top: var(--space-sm); }
.mt-4 { margin-top: var(--space-lg); }

.p-2 { padding: var(--space-sm); }
.p-4 { padding: var(--space-lg); }
.px-4 { padding-left: var(--space-lg); padding-right: var(--space-lg); }
.py-2 { padding-top: var(--space-sm); padding-bottom: var(--space-sm); }

.rounded { border-radius: var(--radius-md); }
.rounded-lg { border-radius: var(--radius-lg); }
.rounded-full { border-radius: var(--radius-full); }

.shadow { box-shadow: var(--shadow-md); }
.shadow-lg { box-shadow: var(--shadow-lg); }
</style>

</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-image">
            <img src="https://raw.githubusercontent.com/HappyWorkPlace/BurnFatForAll/ddf3d033498384b6bc2bfa2a94164182b851ea0e/picture/Emo-1.png" alt="Loading" style="width: 200px; height: 200px; margin-bottom: 10px;">
        </div>
        <div class="loading-text">
            <div>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</div>
            <div style="font-size: 0.9rem; margin-top: 10px; opacity: 0.8;">‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...</div>
        </div>
    </div>

    <div class="app-container">
        <!-- Header -->
        <div class="header">
            <div class="logo-section">
                <div class="logo">
                    <img src="https://raw.githubusercontent.com/HappyWorkPlace/BurnFatForAll/5839a19670212ff1c280dcc98c945503d9004c37/Logo_healthylife2.png" alt="Logo">
                </div>
                <div class="header-text">
                    <h1>‡∏Å‡∏¥‡∏ô‡∏î‡∏µ Healthy Life #2</h1>
                    <p>Happy Work Place : Happy Body</p>
                    <p>NMB Minebea Thai</p>
                </div>
            </div>
        </div>

        <!-- Points Card -->
        <div class="points-card">
            <div class="card-top-section">
                <div class="member-header">
                    <div class="profile-avatar" id="profileAvatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="member-info">
                        <div class="member-name" id="memberName">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
                        <div class="member-dept" id="memberDept">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
                        <div class="member-badge" id="memberBadge">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
                    </div>
                </div>
                
                <div class="points-section">
                    <div class="points-value" id="pointsValue">0</div>
                    <div class="points-label">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏∞‡∏™‡∏°</div>
                </div>
            </div>
            
            <!-- Progress Section -->
            <div class="progress-section">
                <div class="milestones-progress">
                    <div class="progress-track">
                        <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
                    </div>
                    
                    <div class="milestones">
                        <div class="milestone">
                            <div class="milestone-dot">
                                <i class="fas fa-box-tissue milestone-icon"></i>
                            </div>
                            <div class="milestone-label">30</div>
                        </div>
                        <div class="milestone">
                            <div class="milestone-dot">
                                <i class="fas fa-umbrella milestone-icon"></i>
                            </div>
                            <div class="milestone-label">60</div>
                        </div>
                        <div class="milestone">
                            <div class="milestone-dot">
                                <i class="fas fa-box milestone-icon"></i>
                            </div>
                            <div class="milestone-label">90</div>
                        </div>
                        <div class="milestone">
                            <div class="milestone-dot">
                                <i class="fas fa-shopping-bag milestone-icon"></i>
                            </div>
                            <div class="milestone-label">120</div>
                        </div>
                        <div class="milestone">
                            <div class="milestone-dot">
                                <i class="fas fa-glass-water milestone-icon"></i>
                            </div>
                            <div class="milestone-label">150</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gifts Carousel -->
            <div class="gifts-carousel">
                <div class="gifts-container" id="giftsContainer">
                    <!-- Gift Level 30 -->
                    <div class="gift-slide">
                        <div class="gift-content">
                            <div class="gift-icon-large">
                                <img src="https://raw.githubusercontent.com/HappyWorkPlace/BurnFatForAll/3c0d58a21a12b84403f0cf191bcf88fac2a54034/picture/15.png"
                                     alt="‡∏ó‡∏¥‡∏ä‡∏ä‡∏π‡πà‡∏Ñ‡∏∏‡∏°‡∏∞">
                            </div>
                            <div class="gift-details">
                                <div class="gift-name-large">‡∏ó‡∏¥‡∏ä‡∏ä‡∏π‡πà‡∏Ñ‡∏∏‡∏°‡∏∞</div>
                                <div class="gift-points-large">30 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div>
                                <div class="gift-stock-large">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ <span id="gift30-balance">25</span> ‡∏ä‡∏¥‡πâ‡∏ô</div>
                            </div>
                        </div>
                        <div class="gift-action">
                            <button class="gift-button-large" id="gift30" disabled>‡πÅ‡∏•‡∏Å‡∏£‡∏±‡∏ö</button>
                        </div>
                    </div>

                    <!-- Gift Level 60 -->
                    <div class="gift-slide">
                        <div class="gift-content">
                            <div class="gift-icon-large">
                                <img src="https://raw.githubusercontent.com/HappyWorkPlace/BurnFatForAll/32eb73075e8460c39473dc919d86ab725f9509e8/picture/umbrella.png" 
                                     alt="‡∏£‡πà‡∏°‡∏¢‡∏≤‡∏ß‡∏Ñ‡∏•‡∏∞‡∏™‡∏µ">
                            </div>
                            <div class="gift-details">
                                <div class="gift-name-large">‡∏£‡πà‡∏°‡∏¢‡∏≤‡∏ß‡∏Ñ‡∏•‡∏∞‡∏™‡∏µ</div>
                                <div class="gift-points-large">60 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div>
                                <div class="gift-stock-large">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ <span id="gift60-balance">15</span> ‡∏ä‡∏¥‡πâ‡∏ô</div>
                            </div>
                        </div>
                        <div class="gift-action">
                            <button class="gift-button-large" id="gift60" disabled>‡πÅ‡∏•‡∏Å‡∏£‡∏±‡∏ö</button>
                        </div>
                    </div>

                    <!-- Gift Level 90 -->
                    <div class="gift-slide">
                        <div class="gift-content">
                            <div class="gift-icon-large">
                                <img src="https://raw.githubusercontent.com/HappyWorkPlace/BurnFatForAll/3c0d58a21a12b84403f0cf191bcf88fac2a54034/picture/45.png"
                                     alt="‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£">
                            </div>
                            <div class="gift-details">
                                <div class="gift-name-large">‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£ Superlock</div>
                                <div class="gift-points-large">90 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div>
                                <div class="gift-stock-large">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ <span id="gift90-balance">8</span> ‡∏ä‡∏¥‡πâ‡∏ô</div>
                            </div>
                        </div>
                        <div class="gift-action">
                            <button class="gift-button-large" id="gift90" disabled>‡πÅ‡∏•‡∏Å‡∏£‡∏±‡∏ö</button>
                        </div>
                    </div>

                    <!-- Gift Level 120 -->
                    <div class="gift-slide">
                        <div class="gift-content">
                            <div class="gift-icon-large">
                                <img src="https://raw.githubusercontent.com/HappyWorkPlace/BurnFatForAll/3c0d58a21a12b84403f0cf191bcf88fac2a54034/picture/bag-reward.png"
                                     alt="‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡∏Å‡∏¥‡∏ô‡∏î‡∏µ">
                            </div>
                            <div class="gift-details">
                                <div class="gift-name-large">‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡∏ú‡πâ‡∏≤‡∏Å‡∏¥‡∏ô‡∏î‡∏µHealthyLife</div>
                                <div class="gift-points-large">120 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div>
                                <div class="gift-stock-large">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ <span id="gift120-balance">5</span> ‡∏ä‡∏¥‡πâ‡∏ô</div>
                            </div>
                        </div>
                        <div class="gift-action">
                            <button class="gift-button-large" id="gift120" disabled>‡πÅ‡∏•‡∏Å‡∏£‡∏±‡∏ö</button>
                        </div>
                    </div>

                    <!-- Gift Level 150 -->
                    <div class="gift-slide">
                        <div class="gift-content">
                            <div class="gift-icon-large">
                                <img src="https://raw.githubusercontent.com/HappyWorkPlace/BurnFatForAll/3c0d58a21a12b84403f0cf191bcf88fac2a54034/picture/75.png"
                                     alt="‡πÅ‡∏Å‡πâ‡∏ß Locknlock">
                            </div>
                            <div class="gift-details">
                                <div class="gift-name-large">‡πÅ‡∏Å‡πâ‡∏ßLocknlock</div>
                                <div class="gift-points-large">150 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div>
                                <div class="gift-stock-large">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ <span id="gift150-balance">2</span> ‡∏ä‡∏¥‡πâ‡∏ô</div>
                            </div>
                        </div>
                        <div class="gift-action">
                            <button class="gift-button-large" id="gift150" disabled>‡πÅ‡∏•‡∏Å‡∏£‡∏±‡∏ö</button>
                        </div>
                    </div>
                </div>
                
                <div class="carousel-indicators">
                    <div class="indicator-dot active" onclick="scrollToGift(0)"></div>
                    <div class="indicator-dot" onclick="scrollToGift(1)"></div>
                    <div class="indicator-dot" onclick="scrollToGift(2)"></div>
                    <div class="indicator-dot" onclick="scrollToGift(3)"></div>
                    <div class="indicator-dot" onclick="scrollToGift(4)"></div>
                </div>
            </div>
        </div>

        <!-- Navigation -->
        <div class="nav-container">
            <div class="nav-tabs">
                <button class="nav-tab active" onclick="switchTab('record')">
                    <i class="fas fa-utensils"></i>
                    <span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</span>
                </button>
                <button class="nav-tab" onclick="switchTab('history')">
                    <i class="fas fa-history"></i>
                    <span>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</span>
                </button>
            </div>
        </div>

        <!-- Content -->
        <div class="content">
            <!-- Food Recording -->
            <div id="recordSection" class="section active">
                <div class="search-container">
                    <input type="text" class="search-input" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏°‡∏ô‡∏π‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å‡πÇ‡∏£‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£..." id="foodSearch">
                    <i class="fas fa-search search-icon"></i>
                    <div class="dropdown-list" id="foodDropdown">
                        <!-- Food items will be loaded dynamically -->
                    </div>
                </div>
                <button class="record-button btn-primary" id="recordBtn" disabled>
                    <i class="fas fa-save"></i> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏°‡∏ô‡∏π‡∏Å‡πà‡∏≠‡∏ô
                </button>
            </div>

            <!-- History -->
            <div id="historySection" class="section">
                <div class="loading" id="historyLoading">
                    <div class="spinner"></div>
                    <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥...</p>
                </div>
                <div id="historyList">
                    <!-- History items will be loaded dynamically -->
                </div>
            </div>
        </div>
    </div>

    <script>

// Global variables
let userPoints = 0;
let selectedFood = '';
let currentUserData = null;
let userData = null;
let autoScrollInterval = null;
let currentGiftIndex = 0;
let userInteracted = false;

// ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö validation ‡πÅ‡∏•‡∏∞‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏î‡∏ã‡πâ‡∏≥
let validFoodList = []; // ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
let isSubmitting = false; // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏î‡∏ã‡πâ‡∏≥

// ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•
let giftListData = [];
let userGiftStatus = {};

// LIFF Configuration
const LIFF_ID = '2004752543-O6bmBeMw';
const API_URL = 'https://script.google.com/macros/s/AKfycbz5i0Xp6HXqm9gmnraGzkgFoQOLY2ub6qEthUOFRn7yoLabUd3vkfl2VimiEqar_W8/exec';

// Initialize LIFF when page loads
window.onload = function() {
    console.log("Window loaded, initializing app");
    initializeLiff();
};

// Initialize LIFF
function initializeLiff() {
    console.log("Initializing LIFF...");
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('registered') === 'success') {
        // ‡∏•‡∏ö parameter ‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
        window.history.replaceState({}, document.title, window.location.pathname);
        setTimeout(() => {
            Swal.fire({
                title: '‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö!',
                text: '‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß',
                icon: 'success',
                confirmButtonColor: '#10b981',
                timer: 2000
            });
        }, 1000);
    }
    
    if (typeof liff === 'undefined') {
        console.error("LIFF SDK is not defined");
        handleLiffError('LIFF SDK ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô LINE Browser');
        return;
    }

    // Set timeout for LIFF initialization
    const timeoutId = setTimeout(() => {
        console.error("LIFF initialization timeout");
        handleLiffError('‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE ‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
    }, 10000);

    liff.init({
        liffId: LIFF_ID
    }).then(() => {
        clearTimeout(timeoutId);
        console.log("LIFF initialized successfully");
        
        if (liff.isLoggedIn()) {
            console.log("User is logged in, getting profile");
            getUserProfile();
        } else {
            console.log("User is not logged in, redirecting to login");
            liff.login();
        }
    }).catch(err => {
        clearTimeout(timeoutId);
        console.error('LIFF Initialization failed:', err);
        handleLiffError('‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏≠‡∏õ‡πÉ‡∏ô LINE');
    });
}

// Handle LIFF errors
function handleLiffError(message) {
    hideLoadingScreen();
    
    Swal.fire({
        title: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE ‡πÑ‡∏î‡πâ',
        html: `
            <p>${message}</p>
            <div style="margin-top: 15px; padding: 10px; background: #f3f4f6; border-radius: 8px; font-size: 0.85rem;">
                <strong>‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç:</strong><br>
                1. ‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏≠‡∏õ‡πÉ‡∏ô LINE Browser<br>
                2. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï<br>
                3. ‡∏•‡∏≠‡∏á‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡∏°‡πà
            </div>
        `,
        icon: 'warning',
        confirmButtonText: '‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà',
        confirmButtonColor: '#10b981'
    }).then(() => {
        location.reload();
    });
}

// Get user profile from LINE
function getUserProfile() {
    liff.getProfile().then(profile => {
        console.log("Profile obtained: ", profile);
        const uid = profile.userId;
        const displayName = profile.displayName;
        const pictureUrl = profile.pictureUrl;
        
        // Update avatar with LINE profile picture
        updateUserAvatar(displayName, pictureUrl);
        
        // Fetch user data from Google Sheets
        getUserData(uid, displayName);
    }).catch(err => {
        console.error('Failed to get user profile:', err);
        showErrorAndHideLoading('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå LINE ‡πÑ‡∏î‡πâ');
    });
}

// Update user avatar
function updateUserAvatar(displayName, pictureUrl) {
    const profileAvatar = document.getElementById('profileAvatar');
    
    if (pictureUrl) {
        // Use LINE profile picture
        profileAvatar.innerHTML = `<img src="${pictureUrl}" alt="${displayName}" class="profile-image">`;
    } else {
        // Use initials as fallback
        const initials = displayName.substring(0, 2).toUpperCase();
        profileAvatar.innerHTML = initials;
    }
}

// Fetch user data from Google Sheets
function getUserData(uid, displayName) {
    console.log("Fetching user data for UID:", uid);
    
    fetch(`${API_URL}?action=getUserData2&uid=${uid}`)
        .then(response => {
            console.log("User data response received");
            if (!response.ok) {
                throw new Error('Network response was not ok.');
            }
            return response.json();
        })
        .then(data => {
            console.log("User data:", data);
            if (data.error) {
                // User not found in database
                showUserNotFoundError(displayName);
            } else {
                // User found, display data
                displayUserData(data.data, displayName);
            }
        })
        .catch(error => {
            console.error('Error fetching user data:', error);
            showErrorAndHideLoading('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ');
        });
}

// Display user data
function displayUserData(userDataResponse, displayName) {
    console.log("Displaying user data:", userDataResponse);
    
    currentUserData = userDataResponse;
    userData = userDataResponse; // Set global userData
    
    // Parse userData - check if it's an array or object
    let parsedData = {};
    if (Array.isArray(userDataResponse)) {
        // If userData is an array, map it to object structure
        // Array structure: [UID, EmpNo, Name, Division, Factory, Point, ...]
        parsedData = {
            Name: userDataResponse[2] || displayName,
            Division: userDataResponse[3] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡πÅ‡∏ú‡∏ô‡∏Å', 
            Factory: userDataResponse[4] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô',
            Point: userDataResponse[5] || 0
        };
    } else {
        // If userData is already an object
        parsedData = userDataResponse;
    }
    
    console.log("Parsed user data:", parsedData);
    
    // Update UI with user data
    document.getElementById('memberName').textContent = displayName;
    const deptText = parsedData.Name && parsedData.Division 
        ? `${parsedData.Name}<br>${parsedData.Division}` 
        : (parsedData.Name || parsedData.Division || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏');
    document.getElementById('memberDept').innerHTML = deptText;
    document.getElementById('memberBadge').textContent = parsedData.Factory || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô';
    
    // Update points
    userPoints = parseInt(parsedData.Point) || 0;
    updatePointsDisplay(userPoints);
    
    // Load food list
    loadFoodList();
    
    // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡πÇ‡∏´‡∏•‡∏î user data ‡πÄ‡∏™‡∏£‡πá‡∏à
    setTimeout(() => {
        loadGiftData();
    }, 1000);
    
    // Start auto-scroll for carousel
    startAutoScroll();
    
    // Hide loading screen
    hideLoadingScreen();
}

// Show user not found error - redirect to register
function showUserNotFoundError(displayName) {
    hideLoadingScreen();
    
    // Redirect ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    window.location.href = 'https://happyworkplace.github.io/BurnFatForAll/register';
}

// Show error and hide loading
function showErrorAndHideLoading(message) {
    hideLoadingScreen();
    
    Swal.fire({
        title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
        text: message,
        icon: 'error',
        confirmButtonText: '‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö',
        confirmButtonColor: '#ef4444'
    });
}

// Hide loading screen
function hideLoadingScreen() {
    const loadingScreen = document.getElementById('loadingScreen');
    if (loadingScreen) {
        loadingScreen.style.opacity = '0';
        setTimeout(() => {
            loadingScreen.style.display = 'none';
        }, 300);
    }
}

// =================
// Food System
// =================

function loadFoodList() {
    return fetch(`${API_URL}?action=getFoodList&sheetName=MENU&column=A`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // ‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ô global variable
                validFoodList = data.data.filter(food => food && food.trim() !== '' && food !== '-');
                console.log('‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:', validFoodList.length, '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
                
                populateDropdown(validFoodList);
                return validFoodList;
            } else {
                console.error('Failed to fetch food list:', data.message);
                throw new Error('Failed to fetch food list');
            }
        })
        .catch(error => {
            console.error('Error fetching food list:', error);
            // Use fallback food list
            validFoodList = [];
            populateDropdown(validFoodList);
            throw error;
        });
}

function populateDropdown(foodList) {
    const dropdownList = document.getElementById('foodDropdown');
    if (!dropdownList) return;
    
    dropdownList.innerHTML = '';
    
    foodList.forEach(food => {
        const item = document.createElement('div');
        item.className = 'dropdown-item';
        item.textContent = food;
        dropdownList.appendChild(item);
    });
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£
function validateFood(foodName) {
    if (!foodName || foodName.trim() === '') {
        return {
            isValid: false,
            message: '',
            showIcon: false
        };
    }

    const trimmedFood = foodName.trim();
    const isValid = validFoodList.some(food => 
        food.toLowerCase() === trimmedFood.toLowerCase()
    );

    return {
        isValid: isValid,
        message: isValid ? '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‚úì' : '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥',
        showIcon: true
    };
}

// ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ validation
function updateValidationStatus(inputElement, validation) {
    // ‡∏´‡∏≤ container ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
    let statusContainer = inputElement.parentElement.querySelector('.validation-status');
    if (!statusContainer) {
        statusContainer = document.createElement('div');
        statusContainer.className = 'validation-status';
        statusContainer.style.cssText = `
            font-size: 12px;
            margin-top: 5px;
            transition: all 0.3s ease;
            min-height: 16px;
        `;
        inputElement.parentElement.appendChild(statusContainer);
    }

    // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï CSS class ‡∏Ç‡∏≠‡∏á input
    inputElement.classList.remove('valid-food', 'invalid-food');
    
    if (validation.showIcon) {
        if (validation.isValid) {
            inputElement.classList.add('valid-food');
            statusContainer.style.color = '#4CAF50';
            statusContainer.textContent = validation.message;
        } else {
            inputElement.classList.add('invalid-food');
            statusContainer.style.color = '#f44336';
            statusContainer.textContent = validation.message;
        }
    } else {
        statusContainer.textContent = '';
    }
}

// ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô updateRecordButton
function updateRecordButton(food) {
    const button = document.getElementById('recordBtn');
    if (!button) return;
    
    const validation = validateFood(food);
    
    if (validation.isValid && !isSubmitting) {
        button.disabled = false;
        button.innerHTML = '<i class="fas fa-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏ó‡∏≤‡∏ô';
        selectedFood = food.trim();
    } else {
        button.disabled = true;
        if (isSubmitting) {
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
        } else if (food && food.trim() !== '') {
            button.innerHTML = '<i class="fas fa-exclamation-triangle"></i> ‡πÄ‡∏°‡∏ô‡∏π‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
        } else {
            button.innerHTML = '<i class="fas fa-save"></i> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏°‡∏ô‡∏π‡∏Å‡πà‡∏≠‡∏ô';
        }
        selectedFood = '';
    }

    // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï validation status
    const foodInput = document.getElementById('foodSearch');
    if (foodInput) {
        updateValidationStatus(foodInput, validation);
    }
}

// ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á recordSelection ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏î‡∏ã‡πâ‡∏≥
function recordSelection() {
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
    if (isSubmitting) {
        console.log('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏¢‡∏π‡πà ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠...');
        return;
    }

    if (!userData || !selectedFood) {
        Swal.fire({
            title: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡∏≤‡∏´‡∏≤‡∏£',
            text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏°‡∏ô‡∏π‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å',
            icon: 'warning',
            confirmButtonColor: '#10b981'
        });
        return;
    }

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö validation ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
    const validation = validateFood(selectedFood);
    if (!validation.isValid) {
        Swal.fire({
            title: '‡πÄ‡∏°‡∏ô‡∏π‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á',
            text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏°‡∏ô‡∏π‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô',
            icon: 'error',
            confirmButtonColor: '#10b981'
        });
        return;
    }

    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
    isSubmitting = true;
    updateRecordButton(selectedFood); // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï UI ‡∏õ‡∏∏‡πà‡∏°

    Swal.fire({
        title: '‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏õ‡∏£‡∏∂‡∏¢‡∏±‡∏á‡∏ô‡πâ‡∏≤...',
        text: '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà..',
        allowOutsideClick: false,
        didOpen: () => {
            Swal.showLoading();
        }
    });

    liff.getProfile()
        .then(profile => {
            const uid = profile.userId;
            checkUserColumnJ(uid, userData[1], userData[4], selectedFood, userData[2]);
        })
        .catch(err => {
            console.error('Failed to get user profile:', err);
            isSubmitting = false; // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
            updateRecordButton(selectedFood);
            Swal.fire('Error', 'Failed to get user profile. Please try again later.', 'error');
        });
}

function checkUserColumnJ(uid, empNo, factory, selectedFood, name) {
    fetch(`${API_URL}?action=checkUserColumnJ&uid=${uid}`)
        .then(response => response.json())
        .then(data => {
            Swal.close();
            if (data.status === 'TRUE') {
                saveSelection(empNo, factory, selectedFood, uid, name);
            } else if (data.status === 'FALSE') {
                isSubmitting = false; // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
                updateRecordButton(selectedFood);
                Swal.fire({
                    title: '‡πÅ‡∏¢‡πà‡∏à‡∏±‡∏á..',
                    html: `‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∏‡∏ì‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏°‡∏∑‡πà‡∏≠ ${new Date(data.lastTimestamp).toLocaleString()} ‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ‡∏Ñ‡πà‡∏≠‡∏¢‡∏°‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏ô‡∏∞ <br><img src="https://raw.githubusercontent.com/HappyWorkPlace/BurnFatForAll/main/picture/healthy-food_error.png" alt="icon" style="width:100px;height:100px;">`
                });
            } else {
                isSubmitting = false; // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
                updateRecordButton(selectedFood);
                Swal.fire('Error', 'Failed to check user status.', 'error');
            }
        })
        .catch(error => {
            console.error('Error checking user column J:', error);
            isSubmitting = false; // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
            updateRecordButton(selectedFood);
            Swal.fire('Error', 'Failed to check user status. Please try again later.', 'error');
        });
}

function saveSelection(empNo, factory, selectedFood, uid, name) {
    Swal.fire({
        title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
        text: '‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà..',
        allowOutsideClick: false,
        didOpen: () => {
            Swal.showLoading();
        }
    });

    fetch(`${API_URL}?action=saveRedeemData&empNo=${encodeURIComponent(empNo)}&factory=${encodeURIComponent(factory)}&code=${encodeURIComponent(selectedFood)}&name=${encodeURIComponent(name)}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`Network response was not ok: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            Swal.close();
            if (data.success) {
                // Add points and update UI
                userPoints += 5;
                updatePointsDisplay(userPoints);
                
                Swal.fire({
                    title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                    html: '<img src="https://raw.githubusercontent.com/HappyWorkPlace/BurnFatForAll/main/picture/healthy-food_1.png" alt="success" style="width:100px;height:100px;"><p>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß +5 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</p>',
                    showConfirmButton: true,
                    confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á'
                });
                
                // Reset form
                const foodSearch = document.getElementById('foodSearch');
                if (foodSearch) {
                    foodSearch.value = '';
                    foodSearch.classList.remove('valid-food', 'invalid-food');
                }
                selectedFood = '';
                
                // ‡∏•‡πâ‡∏≤‡∏á validation status
                const statusContainer = document.querySelector('.validation-status');
                if (statusContainer) {
                    statusContainer.textContent = '';
                }
                
                // Update gift buttons
                updateGiftButtons(userPoints);
            } else {
                Swal.fire('Error', data.message || 'Failed to save data.', 'error');
            }
        })
        .catch(error => {
            console.error('Error saving data:', error);
            Swal.fire('Error', `Network error: ${error.message}`, 'error');
        })
        .finally(() => {
            // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
            isSubmitting = false;
            updateRecordButton(''); // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï UI ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏Å‡∏ï‡∏¥
        });
}

// =================
// Gift Redeem System
// =================

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏• (‡πÉ‡∏ä‡πâ API ‡πÄ‡∏Å‡πà‡∏≤)
function fetchUserDataForGifts(uid) {
    return fetch(`${API_URL}?action=getUserData&uid=${uid}`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                return data.data;
            } else {
                throw new Error('Error fetching user data for gifts');
            }
        });
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•
function fetchGiftList() {
    return fetch(`${API_URL}?action=getGiftList`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                return data.gifts;
            } else {
                throw new Error('Error fetching gift list');
            }
        });
}

// ‡πÅ‡∏°‡∏õ level ‡πÉ‡∏´‡∏°‡πà‡∏Å‡∏±‡∏ö column index (‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà)
function getColumnIndexByLevel(level) {
    switch (level) {
        case 30:
            return 6; // Column G
        case 60:
            return 7; // Column H
        case 90:
            return 8; // Column I
        case 120:
            return 9; // Column J
        case 150:
            return 10; // Column K
        default:
            return null;
    }
}

// ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏õ‡∏∏‡πà‡∏°‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏• (‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢)
// ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏ß‡∏ô updateGiftButtons ‡πÅ‡∏•‡∏∞ redeemGift functions ‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°

// ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏õ‡∏∏‡πà‡∏°‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏• (‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà - ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô)
function updateGiftButtons(points = userPoints) {
    if (!giftListData || giftListData.length === 0) {
        console.log('Gift data not loaded yet');
        return;
    }

    const requiredPoints = [30, 60, 90, 120, 150];
    
    requiredPoints.forEach(level => {
        const gift = giftListData.find(g => g.Level === level);
        const button = document.getElementById(`gift${level}`);
        const balanceElement = document.getElementById(`gift${level}-balance`);
        
        if (!button) {
            console.log(`Button gift${level} not found`);
            return;
        }

        // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï balance
        if (balanceElement && gift) {
            balanceElement.textContent = gift.Balance || 0;
        }

        // ‡∏î‡∏∂‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á user ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ô‡∏µ‡πâ
        const columnIndex = getColumnIndexByLevel(level);
        const userStatus = userData && columnIndex !== null ? userData[columnIndex] : null;
        const giftBalance = gift ? gift.Balance : 0;

        // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï style ‡πÅ‡∏•‡∏∞ event
        button.onclick = null;
        button.classList.remove('btn-available', 'btn-disabled', 'btn-redeemed', 'btn-outofstock');

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏õ‡∏∏‡πà‡∏°
        if (userStatus === 'R') {
            // ‡∏£‡∏±‡∏ö‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß
            button.textContent = '‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß';
            button.disabled = true;
            button.classList.add('btn-redeemed');
            
        } else if (userStatus === 'O' || giftBalance <= 0) {
            // ‡∏Ç‡∏≠‡∏á‡∏´‡∏°‡∏î
            button.textContent = '‡∏Ç‡∏≠‡∏á‡∏´‡∏°‡∏î';
            button.disabled = true;
            button.classList.add('btn-outofstock');
            
        } else if (points >= level) {
            // ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏û‡∏≠ - ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ
            button.textContent = '‡∏Å‡∏î‡∏£‡∏±‡∏ö';
            button.disabled = false;
            button.classList.add('btn-available');
            button.onclick = () => redeemGift(level);
            
        } else {
            // ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠
            button.textContent = '‡∏Å‡∏î‡∏£‡∏±‡∏ö';
            button.disabled = true;
            button.classList.add('btn-disabled');
        }

        console.log(`Gift ${level}: status=${userStatus}, points=${points}, balance=${giftBalance}, class=${button.className}`);
    });
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•
function redeemGift(level) {
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡πà‡∏≠‡∏ô
    if (isSubmitting) {
        console.log('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏≠‡∏¢‡∏π‡πà ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠...');
        return;
    }

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏£‡∏±‡∏ö
    if (userPoints < level) {
        Swal.fire({
            title: '‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠',
            text: `‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ ${level} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ô‡∏µ‡πâ`,
            icon: 'warning',
            confirmButtonColor: '#10b981'
        });
        return;
    }

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö balance
    const gift = giftListData.find(g => g.Level === level);
    if (!gift || gift.Balance <= 0) {
        Swal.fire({
            title: '‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß',
            text: '‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢ ‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ô‡∏µ‡πâ‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß',
            icon: 'error',
            confirmButtonColor: '#10b981'
        });
        return;
    }

    // ‡πÅ‡∏™‡∏î‡∏á confirmation (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß)
    Swal.fire({
        title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•',
        html: `
            <div style="text-align: center;">
                <div style="font-size: 48px; margin-bottom: 15px;">üéÅ</div>
                <p style="font-size: 18px; font-weight: 600; margin-bottom: 10px;">
                    ‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö <strong style="color: #10b981;">${gift.Gift_Name}</strong>
                </p>
                <p style="font-size: 14px; color: #666; margin-top: 15px;">
                    ‡∏Ñ‡∏•‡∏¥‡∏Å "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠
                </p>
            </div>
        `,
        icon: null,
        showCancelButton: true,
        confirmButtonColor: '#10b981',
        cancelButtonColor: '#6b7280',
        confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö',
        cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
        width: '400px'
    }).then((result) => {
        if (result.isConfirmed) {
            processRedeemGift(level);
        }
    });
}

// ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•
function processRedeemGift(level) {
    isSubmitting = true; // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏î‡∏ã‡πâ‡∏≥

    liff.getProfile().then(profile => {
        const uid = profile.userId;
        
        Swal.fire({
            title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•',
            html: `
                <div style="text-align: center;">
                    <img src="https://raw.githubusercontent.com/HappyWorkPlace/BurnFatForAll/main/picture/giftAnimattion.gif" 
                         alt="loading" style="width:250px;height:250px;">
                    <p style="margin-top: 15px; color: #666; font-size: 16px;">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...</p>
                </div>
            `,
            showConfirmButton: false,
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
                
                fetch(`${API_URL}?action=redeemGift&uid=${uid}&level=${level}`)
                    .then(response => response.json())
                    .then(data => {
                        Swal.close();
                        if (data.success) {
                            // ‡∏£‡∏±‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à - ‡πÑ‡∏°‡πà‡∏´‡∏±‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
                            // userPoints ‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏° ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏•‡∏î‡∏•‡∏á
                            
                            Swal.fire({
                                title: '‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                                html: `
                                    <div style="text-align: center;">
                                        <img src="https://raw.githubusercontent.com/HappyWorkPlace/BurnFatForAll/main/picture/redeemGIF.gif" 
                                             alt="success" style="width:250px;height:250px;">
                                        <p style="margin-top: 15px; font-size: 18px; color: #10b981; font-weight: 600;">
                                            üéâ ‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!
                                        </p>
                                        <p style="margin-top: 10px; font-size: 14px; color: #666;">
                                            ‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏¥‡∏ô‡∏î‡∏µ Healthy Life #2
                                        </p>
                                    </div>
                                `,
                                confirmButtonColor: '#10b981',
                                confirmButtonText: '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£',
                                width: '400px'
                            }).then(() => {
                                // Redirect ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                                window.open('https://liff.line.me/2004752543-O6BZm2yN', '_blank');
                                
                                // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà
                                loadGiftData();
                            });
                        } else {
                            Swal.fire({
                                title: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ',
                                text: data.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á',
                                icon: 'error',
                                confirmButtonColor: '#ef4444'
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Error redeeming gift:', error);
                        Swal.close();
                        Swal.fire({
                            title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
                            text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á',
                            icon: 'error',
                            confirmButtonColor: '#ef4444'
                        });
                    })
                    .finally(() => {
                        isSubmitting = false; // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
                    });
            }
        });
    }).catch(err => {
        console.error('Failed to get user profile:', err);
        isSubmitting = false;
        Swal.fire({
            title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
            text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏î‡πâ',
            icon: 'error',
            confirmButtonColor: '#ef4444'
        });
    });
}

// ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•
function loadGiftData() {
    Promise.all([
        fetchGiftList(),
        liff.getProfile().then(profile => fetchUserDataForGifts(profile.userId))
    ])
    .then(([gifts, userGiftData]) => {
        giftListData = gifts;
        // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï userData ‡∏î‡πâ‡∏ß‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏• (‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£)
        if (userGiftData && Array.isArray(userGiftData)) {
            // Merge ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô userData
            userGiftData.forEach((value, index) => {
                if (userData && index < userData.length) {
                    userData[index] = value;
                }
            });
        }
        
        console.log('Gift data loaded:', giftListData);
        updateGiftButtons(userPoints);
    })
    .catch(error => {
        console.error('Error loading gift data:', error);
        // ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• fallback
        giftListData = [];
        updateGiftButtons(userPoints);
    });
}

// =================
// UI Functions
// =================

// Auto-scroll functionality
function startAutoScroll() {
    const totalGifts = 5;
    
    autoScrollInterval = setInterval(() => {
        if (!userInteracted) {
            currentGiftIndex = (currentGiftIndex + 1) % totalGifts;
            scrollToGift(currentGiftIndex);
        }
    }, 5000);
}

function stopAutoScroll() {
    if (autoScrollInterval) {
        clearInterval(autoScrollInterval);
        userInteracted = true;
        // Resume auto-scroll after 10 seconds of no interaction
        setTimeout(() => {
            userInteracted = false;
            startAutoScroll();
        }, 10000);
    }
}

// Tab switching
function switchTab(tabName) {
    document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    event.target.closest('.nav-tab').classList.add('active');

    document.querySelectorAll('.section').forEach(section => {
        section.classList.remove('active');
    });
    
    const targetSection = document.getElementById(tabName + 'Section');
    if (targetSection) {
        targetSection.classList.add('active');
    }

    if (tabName === 'history') {
        loadHistory();
    }
}

function highlightText(text, keyword) {
    if (!keyword || keyword.trim() === '') return text;
    
    const escapedKeyword = keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    const regex = new RegExp(`(${escapedKeyword})`, 'gi');
    return text.replace(regex, '<span class="highlight">$1</span>');
}

// Fixed progress calculation
function updatePointsDisplay(points) {
    document.getElementById('pointsValue').textContent = points;
    
    const milestoneValues = [30, 60, 90, 120, 150];
    let progressPercent = 0;
    
    // Calculate progress based on milestone segments
    if (points > 150) {
        progressPercent = 100;
    } else {
        for (let i = 0; i < milestoneValues.length; i++) {
            if (points <= milestoneValues[i]) {
                const prevMilestone = i === 0 ? 0 : milestoneValues[i - 1];
                const currentMilestone = milestoneValues[i];
                const segmentProgress = (points - prevMilestone) / (currentMilestone - prevMilestone);
                const baseProgress = (i / milestoneValues.length) * 100;
                const segmentWidth = (1 / milestoneValues.length) * 100;
                progressPercent = baseProgress + (segmentProgress * segmentWidth);
                break;
            }
        }
    }
    
    document.getElementById('progressFill').style.width = progressPercent + '%';
    
    // Update milestone states
    const milestones = document.querySelectorAll('.milestone');
    
    milestones.forEach((milestone, index) => {
        const milestoneValue = milestoneValues[index];
        milestone.classList.remove('achieved', 'current');
        
        if (points >= milestoneValue) {
            milestone.classList.add('achieved');
        } else if (index === 0 && points >= 0 && points < milestoneValue) {
            milestone.classList.add('current');
        } else if (index > 0 && points >= milestoneValues[index - 1] && points < milestoneValue) {
            milestone.classList.add('current');
        }
    });

    updateGiftButtons(points);
}

// ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô loadHistory() ‡πÄ‡∏î‡∏¥‡∏°‡∏î‡πâ‡∏ß‡∏¢‡πÇ‡∏Ñ‡πâ‡∏î‡∏ô‡∏µ‡πâ

// ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö pagination
let historyData = [];
let currentPage = 1;
let recordsPerPage = 10;

function loadHistory() {
    const loading = document.getElementById('historyLoading');
    const list = document.getElementById('historyList');
    
    loading.style.display = 'block';
    list.style.display = 'none';
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ userData ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    if (!userData || !Array.isArray(userData) || userData.length === 0) {
        console.error('User data not available for history');
        loading.style.display = 'none';
        list.style.display = 'block';
        showErrorHistory();
        return;
    }
    
    // ‡πÉ‡∏ä‡πâ UID ‡∏à‡∏≤‡∏Å userData ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å liff.getProfile()
    const userId = userData[0]; // UID ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô index 0
    
    if (!userId) {
        console.error('User ID not found in userData');
        loading.style.display = 'none';
        list.style.display = 'block';
        showErrorHistory();
        return;
    }
    
    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API ‡∏î‡∏∂‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
    fetch(`${API_URL}?action=getUserRecords&uid=${userId}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            loading.style.display = 'none';
            list.style.display = 'block';
            
            if (data.success && data.records && data.records.length > 0) {
                historyData = data.records;
                currentPage = 1;
                displayHistory();
            } else {
                showEmptyHistory();
            }
        })
        .catch(error => {
            console.error('Error loading history:', error);
            loading.style.display = 'none';
            list.style.display = 'block';
            showErrorHistory();
        });
}

function displayHistory() {
    const list = document.getElementById('historyList');
    
    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ
    const startIndex = (currentPage - 1) * recordsPerPage;
    const endIndex = startIndex + recordsPerPage;
    const pageRecords = historyData.slice(startIndex, endIndex);
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
    let historyHTML = '';
    
    pageRecords.forEach(record => {
        const dateTime = formatDateTime(record.TimeStamp);
        const menu = record.Menu || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏°‡∏ô‡∏π';
        
        historyHTML += `
            <div class="history-item">
                <div class="history-date">${dateTime}</div>
                <div class="history-food">${menu}</div>
            </div>
        `;
    });
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á pagination
    const totalPages = Math.ceil(historyData.length / recordsPerPage);
    const paginationHTML = createPagination(currentPage, totalPages);
    
    // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
    list.innerHTML = historyHTML + paginationHTML;
}

function formatDateTime(timestamp) {
    if (!timestamp) return '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏ß‡∏•‡∏≤';
    
    try {
        const date = new Date(timestamp);
        
        // ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏ö‡∏ö‡∏á‡πà‡∏≤‡∏¢‡πÜ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ‡πÄ‡∏ß‡∏•‡∏≤
        const dateStr = date.toLocaleDateString('th-TH', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit'
        });
        
        const timeStr = date.toLocaleTimeString('th-TH', {
            hour: '2-digit',
            minute: '2-digit'
        });
        
        return `${dateStr} ${timeStr}`;
    } catch (error) {
        console.error('Error formatting date:', error);
        return '‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
    }
}

function createPagination(current, total) {
    if (total <= 1) return '';
    
    let paginationHTML = '<div class="pagination-container">';
    
    // ‡∏õ‡∏∏‡πà‡∏° Previous
    if (current > 1) {
        paginationHTML += `
            <button class="pagination-btn" onclick="changePage(${current - 1})">
                ‚Üê ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤
            </button>
        `;
    }
    
    // ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
    paginationHTML += `
        <span class="pagination-info">
            ‡∏´‡∏ô‡πâ‡∏≤ ${current} ‡∏à‡∏≤‡∏Å ${total}
        </span>
    `;
    
    // ‡∏õ‡∏∏‡πà‡∏° Next
    if (current < total) {
        paginationHTML += `
            <button class="pagination-btn" onclick="changePage(${current + 1})">
                ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚Üí
            </button>
        `;
    }
    
    paginationHTML += '</div>';
    return paginationHTML;
}

function changePage(page) {
    currentPage = page;
    displayHistory();
    
    // ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô
    const historySection = document.getElementById('historySection');
    if (historySection) {
        historySection.scrollTop = 0;
    }
}

function showEmptyHistory() {
    const list = document.getElementById('historyList');
    list.innerHTML = `
        <div class="empty-history">
            <div style="text-align: center; padding: 40px 20px; color: #64748b;">
                <div style="font-size: 48px; margin-bottom: 15px; opacity: 0.5;">üìù</div>
                <h3 style="margin-bottom: 10px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</h3>
                <p>‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏•‡∏¢!</p>
            </div>
        </div>
    `;
}

function showErrorHistory() {
    const list = document.getElementById('historyList');
    list.innerHTML = `
        <div class="error-history">
            <div style="text-align: center; padding: 40px 20px; color: #ef4444;">
                <div style="font-size: 48px; margin-bottom: 15px;">‚ö†Ô∏è</div>
                <h3 style="margin-bottom: 10px;">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÑ‡∏î‡πâ</h3>
                <p style="color: #64748b; margin-bottom: 15px;">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</p>
                <button onclick="loadHistory()" style="padding: 8px 16px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer;">
                    ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà
                </button>
            </div>
        </div>
    `;
}

// ‡πÄ‡∏û‡∏¥‡πà‡∏° CSS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö pagination (‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏á‡πà‡∏≤‡∏¢)
const historyStyle = document.createElement('style');
historyStyle.textContent = `
    .history-header {
        border-bottom: 1px solid #e2e8f0;
        padding-bottom: 10px;
        margin-bottom: 20px;
    }
    
    .pagination-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 20px;
        padding: 15px 0;
        border-top: 1px solid #f1f5f9;
    }
    
    .pagination-btn {
        padding: 8px 16px;
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        color: #374151;
        transition: all 0.2s ease;
    }
    
    .pagination-btn:hover {
        background: #e2e8f0;
        border-color: #cbd5e1;
    }
    
    .pagination-btn:active {
        transform: scale(0.98);
    }
    
    .pagination-info {
        font-size: 14px;
        color: #64748b;
        font-weight: 500;
    }
    
    .empty-history, .error-history {
        min-height: 200px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    /* Responsive */
    @media (max-width: 480px) {
        .pagination-container {
            flex-direction: column;
            gap: 10px;
        }
        
        .pagination-btn {
            padding: 10px 20px;
            font-size: 13px;
        }
        
        .pagination-info {
            order: -1;
            margin-bottom: 5px;
        }
    }
`;
document.head.appendChild(historyStyle);

// Carousel functionality
function scrollToGift(index) {
    const container = document.getElementById('giftsContainer');
    const giftWidth = container.children[0].offsetWidth;
    container.scrollTo({
        left: giftWidth * index,
        behavior: 'smooth'
    });
    updateIndicators(index);
    currentGiftIndex = index;
    stopAutoScroll();
}

function updateIndicators(activeIndex) {
    const indicators = document.querySelectorAll('.indicator-dot');
    indicators.forEach((indicator, index) => {
        if (index === activeIndex) {
            indicator.classList.add('active');
        } else {
            indicator.classList.remove('active');
        }
    });
}

// =================
// Event Listeners
// =================

// Food search functionality
document.getElementById('foodSearch').addEventListener('input', function() {
    const value = this.value;
    const dropdown = document.getElementById('foodDropdown');
    
    if (value.length > 0) {
        dropdown.style.display = 'block';
        const items = dropdown.querySelectorAll('.dropdown-item');
        let hasVisibleItems = false;
        
        items.forEach(item => {
            const foodName = item.textContent;
            if (foodName.toLowerCase().includes(value.toLowerCase())) {
                item.style.display = 'block';
                // ‡πÄ‡∏û‡∏¥‡πà‡∏° highlight
                item.innerHTML = highlightText(foodName, value);
                hasVisibleItems = true;
            } else {
                item.style.display = 'none';
            }
        });
        
        // ‡∏ã‡πà‡∏≠‡∏ô dropdown ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô
        if (!hasVisibleItems) {
            dropdown.style.display = 'none';
        }
    } else {
        dropdown.style.display = 'none';
    }

    updateRecordButton(value);
});

// dropdown click event
document.getElementById('foodDropdown').addEventListener('click', function(e) {
    if (e.target.classList.contains('dropdown-item')) {
        const searchInput = document.getElementById('foodSearch');
        const selectedText = e.target.textContent;
        
        searchInput.value = selectedText;
        selectedFood = selectedText;
        this.style.display = 'none';
        updateRecordButton(selectedFood);
        
        // Focus ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ó‡∏µ‡πà input
        searchInput.focus();
    }
});

document.addEventListener('click', function(e) {
    if (!e.target.closest('.search-container')) {
        document.getElementById('foodDropdown').style.display = 'none';
    }
});

// Record food event
document.getElementById('recordBtn').addEventListener('click', function() {
    if (selectedFood && !isSubmitting) {
        recordSelection();
    }
});

// Auto-update indicators on scroll and handle user interaction
document.getElementById('giftsContainer').addEventListener('scroll', function() {
    const container = this;
    const giftWidth = container.children[0].offsetWidth;
    const scrollLeft = container.scrollLeft;
    const activeIndex = Math.round(scrollLeft / giftWidth);
    updateIndicators(activeIndex);
    currentGiftIndex = activeIndex;
});

// Stop auto-scroll on user touch/scroll
document.getElementById('giftsContainer').addEventListener('touchstart', stopAutoScroll);
document.getElementById('giftsContainer').addEventListener('mousedown', stopAutoScroll);

// =================
// CSS Styles
// =================

// Add animation styles
const style = document.createElement('style');
style.textContent = `
    @keyframes slideDown {
        from { transform: translate(-50%, -100%); opacity: 0; }
        to { transform: translate(-50%, 0); opacity: 1; }
    }
    
    /* CSS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö validation states */
    .valid-food {
        border-color: #4CAF50 !important;
        background: rgba(232, 245, 232, 0.8) !important;
        box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1) !important;
    }
    
    .invalid-food {
        border-color: #f44336 !important;
        background: rgba(255, 235, 235, 0.8) !important;
        box-shadow: 0 0 0 3px rgba(244, 67, 54, 0.1) !important;
    }
    
    .validation-status {
        font-size: 12px;
        margin-top: 5px;
        transition: all 0.3s ease;
        min-height: 16px;
    }
    
    /* ‡∏õ‡∏∏‡πà‡∏° loading state */
    #recordBtn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }
    
    #recordBtn.loading {
        animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
        0% { opacity: 0.6; }
        50% { opacity: 1; }
        100% { opacity: 0.6; }
    }
    
    /* ‡∏õ‡∏∏‡πà‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏•‡∏Å - ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß */
    .gift-button-large.btn-available {
        background: linear-gradient(135deg, #10b981, #059669) !important;
        color: white !important;
        border: none !important;
        cursor: pointer !important;
        transition: all 0.3s ease !important;
        font-weight: 600 !important;
    }
    
    .gift-button-large.btn-available:hover {
        transform: translateY(-2px) !important;
        box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3) !important;
        background: linear-gradient(135deg, #059669, #047857) !important;
    }
    
    .gift-button-large.btn-available:active {
        transform: translateY(0) !important;
    }
    
    /* ‡∏õ‡∏∏‡πà‡∏°‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏•‡∏Å - ‡∏™‡∏µ‡πÄ‡∏ó‡∏≤ */
    .gift-button-large.btn-disabled {
        background: #9ca3af !important;
        color: #6b7280 !important;
        border: none !important;
        cursor: not-allowed !important;
        font-weight: 500 !important;
        opacity: 0.8 !important;
    }
    
    /* ‡∏õ‡∏∏‡πà‡∏°‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß - ‡∏™‡∏µ‡πÄ‡∏ó‡∏≤‡πÄ‡∏Ç‡πâ‡∏° */
    .gift-button-large.btn-redeemed {
        background: #6b7280 !important;
        color: #f3f4f6 !important;
        border: none !important;
        cursor: not-allowed !important;
        font-weight: 500 !important;
        opacity: 0.9 !important;
    }
    
    /* ‡∏õ‡∏∏‡πà‡∏°‡∏Ç‡∏≠‡∏á‡∏´‡∏°‡∏î - ‡∏™‡∏µ‡πÅ‡∏î‡∏á‡∏≠‡πà‡∏≠‡∏ô */
    .gift-button-large.btn-outofstock {
        background: #ef4444 !important;
        color: white !important;
        border: none !important;
        cursor: not-allowed !important;
        font-weight: 500 !important;
        opacity: 0.8 !important;
    }
    
    /* ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö balance display */
    [id$="-balance"] {
        font-weight: bold !important;
        color: #059669 !important;
    }
    
    /* Responsive */
    @media (max-width: 480px) {
        .gift-button-large {
            font-size: 12px !important;
            padding: 10px 16px !important;
            min-width: 70px !important;
            height: 40px !important;
        }
    }
`;
document.head.appendChild(style);

// =================
// Initialize App
// =================

// Initialize app
document.addEventListener('DOMContentLoaded', function() {
    // Initialize gift buttons
    updateGiftButtons();
});
    </script>
</body>
</html>
