<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NMB HappyWorkPlace - ‡∏Å‡∏¥‡∏ô‡∏î‡∏µ Healthy Life#2</title>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<!--     <script src='https://kit.fontawesome.com/a076d05399.js' crossorigin='anonymous'></script> -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
/* =================================
   üé® CSS VARIABLES & DESIGN TOKENS
   ================================= */
:root {
    /* üé® Colors */
    --primary-500: #10b981;
    --primary-600: #059669;
    --primary-700: #047857;
    
    --secondary-50: #f8fafc;
    --secondary-100: #f1f5f9;
    --secondary-200: #e2e8f0;
    --secondary-300: #cbd5e1;
    --secondary-400: #94a3b8;
    --secondary-500: #64748b;
    --secondary-600: #475569;
    --secondary-700: #334155;
    --secondary-800: #1e293b;
    
    --success-400: #4ade80;
    --success-500: #22c55e;
    --warning-400: #fbbf24;
    --warning-500: #f59e0b;
    --error-400: #f87171;
    --error-500: #ef4444;
    
    --white: #ffffff;
    --black: #000000;
    
    /* üìè Spacing */
    --space-xs: 4px;
    --space-sm: 8px;
    --space-md: 12px;
    --space-lg: 16px;
    --space-xl: 20px;
    --space-2xl: 24px;
    --space-3xl: 32px;
    --space-4xl: 40px;
    
    /* üî§ Typography */
    --text-xs: 0.65rem;
    --text-sm: 0.75rem;
    --text-base: 0.9rem;
    --text-lg: 1rem;
    --text-xl: 1.1rem;
    --text-2xl: 1.2rem;
    --text-3xl: 2rem;
    --text-4xl: 2.4rem;
    
    --font-light: 300;
    --font-normal: 400;
    --font-medium: 500;
    --font-semibold: 600;
    --font-bold: 700;
    
    /* üéØ Border Radius */
    --radius-sm: 8px;
    --radius-md: 12px;
    --radius-lg: 16px;
    --radius-xl: 20px;
    --radius-2xl: 24px;
    --radius-full: 50%;
    
    /* üåä Shadows */
    --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.04);
    --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.05);
    --shadow-lg: 0 8px 25px rgba(0, 0, 0, 0.1);
    --shadow-xl: 0 12px 40px rgba(0, 0, 0, 0.1);
    
    /* üé≠ Gradients */
    --gradient-primary: linear-gradient(135deg, var(--primary-500), var(--primary-600));
    --gradient-bg: linear-gradient(135deg, var(--secondary-50) 0%, var(--secondary-200) 100%);
    --gradient-card: linear-gradient(135deg, var(--white), var(--secondary-50));
    
    /* üì± Container */
    --container-max: 420px;
    --container-padding: var(--space-lg);
}

/* =================================
   üîß RESET & BASE STYLES
   ================================= */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Prompt', sans-serif;
    background: var(--gradient-bg);
    min-height: 100vh;
    color: var(--secondary-800);
    overflow-x: hidden;
    font-size: var(--text-base);
    line-height: 1.5;
    padding-bottom: 200px;
}

/* =================================
   üì± LAYOUT COMPONENTS
   ================================= */

/* App Container */
.app-container {
    max-width: var(--container-max);
    margin: 0 auto;
    background: var(--white);
    min-height: 100vh;
    box-shadow: var(--shadow-xl);
    position: relative;
}

/* Header */
.header {
    background: var(--gradient-primary);
    color: var(--white);
    padding: var(--space-sm) var(--space-xs) var(--space-xs);
    text-align: left;
    position: relative;
}

.logo-section {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-xl);
    margin-bottom: var(--space-sm);
}

.logo {
    width: 120px;
    height: 120px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.logo img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: var(--radius-md);
}

.header-text h1 {
    font-size: var(--text-xl);
    font-weight: var(--font-semibold);
    margin-bottom: var(--space-xs);
}

.header-text p {
    font-size: var(--text-sm);
    opacity: 0.9;
    margin-bottom: var(--space-xs);
}

/* Content Areas */
.content {
    padding: 0 var(--container-padding) var(--space-3xl);
}

.nav-container {
    padding: 0 var(--space-xl);
    margin-bottom: var(--space-2xl);
}

/* =================================
   üé¥ CARD COMPONENTS
   ================================= */

/* Points Card */
.points-card {
    background: var(--gradient-card);
    margin: var(--space-lg);
    padding: var(--space-2xl) var(--space-lg);
    border-radius: var(--radius-2xl);
    box-shadow: var(--shadow-xl);
    border: 1px solid var(--secondary-200);
    position: relative;
    overflow: hidden;
}

.points-card::before {
    content: '';
    position: absolute;
    top: 0;
    right: 0;
    width: 100px;
    height: 100px;
    background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(5, 150, 105, 0.05));
    border-radius: 0 0 0 100px;
}

.card-top-section {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-xl);
    position: relative;
    z-index: 1;
}

/* Member Info */
.member-header {
    display: flex;
    align-items: center;
    gap: var(--space-md);
}

.profile-avatar {
    width: 80px;
    height: 80px;
    border-radius: var(--radius-lg);
    background: var(--gradient-primary);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--white);
    font-size: var(--text-xl);
    box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
    border: 3px solid var(--white);
    overflow: hidden;
}

.profile-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: var(--radius-sm);
}

.member-info {
    flex: 1;
}

.member-name {
    font-size: var(--text-base);
    font-weight: var(--font-semibold);
    color: var(--secondary-800);
    margin-bottom: var(--space-xs);
}

.member-dept {
    font-size: var(--text-sm);
    color: var(--secondary-500);
    margin-bottom: var(--space-xs);
}

.member-badge {
    display: inline-block;
    background: var(--gradient-primary);
    color: var(--white);
    padding: var(--space-xs) var(--space-md);
    border-radius: var(--space-sm);
    font-size: var(--text-xs);
    font-weight: var(--font-semibold);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* Points Display */
.points-section {
    text-align: right;
}

.points-value {
    font-size: var(--text-3xl);
    font-weight: var(--font-bold);
    background: var(--gradient-primary);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: var(--space-xs);
    line-height: 1;
}

.points-label {
    font-size: var(--text-sm);
    color: var(--secondary-500);
    font-weight: var(--font-medium);
}

/* =================================
   üéØ PROGRESS & MILESTONES
   ================================= */

.progress-section {
    position: relative;
    margin-top: var(--space-md);
}

.milestones-progress {
    position: relative;
    padding: 0;
}

.progress-track {
    height: 6px;
    background: var(--secondary-100);
    border-radius: var(--radius-md);
    position: absolute;
    top: 31%;
    left: var(--space-md);
    right: var(--space-md);
    transform: translateY(-50%);
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--primary-500), #34d399);
    border-radius: var(--radius-md);
    transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
}

.progress-fill::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
    animation: shimmer 2s infinite;
}

.milestones {
    position: relative;
    padding: 0;
    height: 60px;
}

.milestone {
    position: absolute;
    display: flex;
    flex-direction: column;
    align-items: center;
    z-index: 2;
    transform: translateX(-50%);
}

.milestone:nth-child(1) { left: 19%; }
.milestone:nth-child(2) { left: 39%; }
.milestone:nth-child(3) { left: 59%; }
.milestone:nth-child(4) { left: 79%; }
.milestone:nth-child(5) { left: 95%; }

.milestone-dot {
    width: 28px;
    height: 28px;
    border-radius: var(--radius-full);
    background: var(--secondary-200);
    border: 3px solid var(--white);
    box-shadow: var(--shadow-md);
    margin-bottom: var(--space-sm);
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: var(--text-sm);
}

.milestone.achieved .milestone-dot {
    background: var(--primary-500);
    box-shadow: 0 2px 12px rgba(16, 185, 129, 0.4);
    color: var(--white);
}

.milestone.current .milestone-dot {
    background: var(--warning-500);
    box-shadow: 0 2px 12px rgba(245, 158, 11, 0.4);
    animation: pulse 2s infinite;
    color: var(--white);
}

.milestone-icon {
    display: block;
    color: var(--white);
}

.milestone-label {
    font-size: var(--text-sm);
    color: var(--secondary-500);
    font-weight: var(--font-medium);
    background: var(--white);
    padding: var(--space-xs) var(--space-sm);
    border-radius: var(--radius-sm);
    box-shadow: var(--shadow-sm);
}

.milestone.achieved .milestone-label {
    color: var(--primary-500);
    font-weight: var(--font-semibold);
}

.milestone.current .milestone-label {
    color: var(--warning-500);
    font-weight: var(--font-semibold);
}

/* =================================
   üé† CAROUSEL COMPONENTS
   ================================= */

.gifts-carousel {
    margin-top: var(--space-xs);
}

.gifts-container {
    display: flex;
    overflow-x: auto;
    scroll-behavior: smooth;
    -webkit-overflow-scrolling: touch;
    scroll-snap-type: x mandatory;
    gap: 0;
    /* ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏•‡∏≤‡∏¢ items */
    flex-wrap: nowrap;
}

.gifts-container::-webkit-scrollbar {
    height: 4px;
}

.gifts-container::-webkit-scrollbar-track {
    background: var(--secondary-100);
    border-radius: var(--space-xs);
}

.gifts-container::-webkit-scrollbar-thumb {
    background: var(--secondary-300);
    border-radius: var(--space-xs);
}

.gifts-container::-webkit-scrollbar-thumb:hover {
    background: var(--secondary-400);
}

.gift-slide {
    flex-shrink: 0;
    width: 100%; /* ‡πÅ‡∏ï‡πà‡∏•‡∏∞ slide ‡πÄ‡∏ï‡πá‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á */
    min-width: 100%; /* ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡πá‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á */
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: var(--space-lg) var(--space-md);
    scroll-snap-align: start;
    background: transparent;
    box-sizing: border-box;
}

.gift-content {
    display: flex;
    align-items: center;
    gap: var(--space-lg);
    flex: 1;
    max-width: calc(100% - 90px); /* ‡πÄ‡∏ß‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏° */
}

.gift-icon-large {
    width: 64px;
    height: 64px;
    border-radius: var(--radius-lg);
    background: rgba(16, 185, 129, 0.1);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: var(--text-2xl);
    border: 2px solid rgba(16, 185, 129, 0.2);
    flex-shrink: 0;
}

.gift-icon-large img {
    width: 48px;
    height: 48px;
    object-fit: contain;
}

.gift-details {
    flex: 1;
    min-width: 0; /* ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô overflow */
}

.gift-name-large {
    font-weight: var(--font-semibold);
    font-size: var(--text-lg);
    color: var(--secondary-800);
    margin-bottom: var(--space-sm);
    line-height: 1.3;
    /* ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ */
    overflow: hidden;
    text-overflow: ellipsis;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
}

.gift-points-large {
    font-size: var(--text-base);
    color: var(--primary-500);
    font-weight: var(--font-semibold);
    margin-bottom: var(--space-xs);
}

.gift-stock-large {
    font-size: var(--text-sm);
    color: var(--secondary-500);
}

.gift-action {
    flex-shrink: 0;
    margin-left: var(--space-md);
}

/* Carousel Indicators */
.carousel-indicators {
    display: flex;
    justify-content: center;
    gap: var(--space-sm);
    margin: var(--space-lg) 0;
}

.indicator-dot {
    width: 6px;
    height: 6px;
    border-radius: var(--radius-full);
    background: var(--secondary-300);
    cursor: pointer;
    transition: all 0.3s ease;
}

.indicator-dot.active {
    background: var(--primary-500);
    transform: scale(1.2);
}

/* =================================
   üîò BUTTON COMPONENTS
   ================================= */

/* Base Button Styles */
.btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-sm);
    padding: var(--space-md) var(--space-xl);
    border: none;
    border-radius: var(--radius-lg);
    font-family: 'Prompt', sans-serif;
    font-weight: var(--font-semibold);
    font-size: var(--text-sm);
    cursor: pointer;
    transition: all 0.3s ease;
    text-decoration: none;
    white-space: nowrap;
    min-height: 44px; /* Touch target */
}

/* Primary Button */
.btn-primary {
    background: var(--gradient-primary);
    color: var(--white);
    box-shadow: var(--shadow-md);
}

.btn-primary:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
}

.btn-primary:disabled {
    background: var(--secondary-200);
    color: var(--secondary-400);
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
}

/* Gift Buttons */
.gift-button-large {
    padding: var(--space-md) var(--space-xl);
    background: var(--gradient-primary);
    color: var(--white);
    border: none;
    border-radius: var(--radius-lg);
    font-weight: var(--font-semibold);
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: var(--text-sm);
    font-family: 'Prompt', sans-serif;
    white-space: nowrap;
    min-width: 70px;
    min-height: 40px;
}

.gift-button-large:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
}

.gift-button-large:disabled {
    background: var(--secondary-200);
    color: var(--secondary-400);
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
}

/* Button States */
.btn-available {
    background: var(--gradient-primary) !important;
    color: var(--white) !important;
}

.btn-disabled {
    background: var(--secondary-400) !important;
    color: var(--secondary-500) !important;
    opacity: 0.8 !important;
}

.btn-redeemed {
    background: var(--secondary-500) !important;
    color: var(--secondary-100) !important;
    opacity: 0.9 !important;
}

.btn-outofstock {
    background: var(--error-500) !important;
    color: var(--white) !important;
    opacity: 0.8 !important;
}

/* Record Button */
.record-button {
    width: 100%;
    padding: var(--space-lg);
    background: var(--gradient-primary);
    color: var(--white);
    border: none;
    border-radius: var(--radius-lg);
    font-size: var(--text-lg);
    font-weight: var(--font-semibold);
    cursor: pointer;
    transition: all 0.3s ease;
    margin-top: var(--space-md);
    font-family: 'Prompt', sans-serif;
    min-height: 56px;
}

.record-button:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
}

.record-button:disabled {
    background: var(--secondary-200);
    color: var(--secondary-400);
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
}

/* =================================
   üì± NAVIGATION
   ================================= */

.nav-tabs {
    display: flex;
    background: var(--secondary-50);
    border-radius: var(--radius-lg);
    padding: var(--space-xs);
    border: 1px solid var(--secondary-200);
}

.nav-tab {
    flex: 1;
    padding: var(--space-sm) var(--space-xs);
    text-align: center;
    border-radius: var(--radius-md);
    font-size: var(--text-sm);
    font-weight: var(--font-medium);
    cursor: pointer;
    transition: all 0.2s ease;
    background: transparent;
    border: none;
    color: var(--secondary-500);
    min-height: 40px;
}

.nav-tab.active {
    background: var(--white);
    color: var(--primary-500);
    box-shadow: var(--shadow-sm);
    font-weight: var(--font-semibold);
}

.nav-tab i {
    display: block;
    font-size: var(--text-lg);
    margin-bottom: 2px;
}
/* =================================
   üìù FORM COMPONENTS
   ================================= */

.search-container {
    position: relative;
    margin-bottom: var(--space-xl);
}

.search-input {
    width: 100%;
    padding: var(--space-lg) var(--space-xl) var(--space-lg) 50px;
    border: 2px solid var(--secondary-200);
    border-radius: var(--radius-lg);
    font-size: var(--text-lg);
    background: var(--white);
    transition: all 0.3s ease;
    font-family: 'Prompt', sans-serif;
    min-height: 56px;
}

.search-input:focus {
    outline: none;
    border-color: var(--primary-500);
    box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
}

.search-icon {
    position: absolute;
    left: 18px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--secondary-400);
    font-size: var(--text-xl);
}

/* Validation States */
.valid-food {
    border-color: var(--success-500) !important;
    background: rgba(34, 197, 94, 0.05) !important;
    box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.1) !important;
}

.invalid-food {
    border-color: var(--error-500) !important;
    background: rgba(239, 68, 68, 0.05) !important;
    box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1) !important;
}

.validation-status {
    font-size: var(--text-xs);
    margin-top: var(--space-sm);
    transition: all 0.3s ease;
    min-height: 16px;
}

/* Dropdown */
.dropdown-list {
    position: absolute;
    top: calc(100% + var(--space-sm));
    left: 0;
    right: 0;
    background: var(--white);
    border-radius: var(--radius-lg);
    border: 1px solid var(--secondary-200);
    box-shadow: var(--shadow-xl);
    max-height: 240px;
    overflow-y: auto;
    z-index: 100;
    display: none;
}

.dropdown-item {
    padding: var(--space-lg) var(--space-xl);
    cursor: pointer;
    transition: background 0.2s ease;
    border-bottom: 1px solid var(--secondary-100);
}

.dropdown-item:hover {
    background: var(--secondary-50);
}

.dropdown-item:last-child {
    border-bottom: none;
}

/* =================================
   üìã CONTENT SECTIONS
   ================================= */

.section {
    display: none;
}

.section.active {
    display: block;
    animation: fadeIn 0.3s ease;
}

/* History */
.history-item {
    background: var(--white);
    padding: var(--space-lg) var(--space-xl);
    border-radius: var(--radius-lg);
    margin-bottom: var(--space-lg);
    border: 1px solid var(--secondary-100);
    box-shadow: var(--shadow-sm);
    border-left: 4px solid var(--primary-500);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.history-item:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
    border-left-color: var(--primary-600);
}

.history-item::before {
    content: '';
    position: absolute;
    top: 0;
    right: 0;
    width: 60px;
    height: 60px;
    background: linear-gradient(135deg, rgba(16, 185, 129, 0.05), rgba(5, 150, 105, 0.02));
    border-radius: 0 0 0 60px;
}

.history-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: var(--space-xl);
    padding-bottom: var(--space-md);
    border-bottom: 2px solid var(--secondary-100);
}

.history-title {
    font-size: var(--text-xl);
    font-weight: var(--font-semibold);
    color: var(--secondary-800);
    display: flex;
    align-items: center;
    gap: var(--space-md);
}

.history-title i {
    color: var(--primary-500);
    font-size: var(--text-2xl);
}

.history-count {
    background: var(--gradient-primary);
    color: var(--white);
    padding: var(--space-xs) var(--space-md);
    border-radius: var(--radius-full);
    font-size: var(--text-sm);
    font-weight: var(--font-semibold);
    min-width: 24px;
    text-align: center;
}

.history-date {
    font-size: var(--text-sm);
    color: var(--secondary-500);
    margin-bottom: var(--space-sm);
    font-weight: var(--font-medium);
    display: flex;
    align-items: center;
    gap: var(--space-sm);
}

.history-date i {
    color: var(--primary-500);
    font-size: var(--text-sm);
}

.history-food {
    font-weight: var(--font-semibold);
    color: var(--secondary-800);
    font-size: var(--text-lg);
    display: flex;
    align-items: center;
    gap: var(--space-md);
}

.history-food::before {
    content: 'üçΩÔ∏è';
    font-size: var(--text-xl);
}

/* Pagination Styles */
.pagination-container {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: var(--space-lg);
    margin-top: var(--space-2xl);
    padding: var(--space-xl) 0;
    border-top: 1px solid var(--secondary-100);
    background: linear-gradient(135deg, var(--secondary-50), var(--white));
    border-radius: var(--radius-lg);
    position: relative;
}

.pagination-container::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, rgba(16, 185, 129, 0.02), rgba(5, 150, 105, 0.01));
    border-radius: var(--radius-lg);
    z-index: -1;
}

.pagination-btn {
    padding: var(--space-md) var(--space-xl);
    background: var(--gradient-primary);
    color: var(--white);
    border: none;
    border-radius: var(--radius-lg);
    cursor: pointer;
    font-size: var(--text-base);
    font-weight: var(--font-semibold);
    font-family: 'Prompt', sans-serif;
    transition: all 0.3s ease;
    box-shadow: var(--shadow-sm);
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    min-width: 120px;
    justify-content: center;
}

.pagination-btn:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
    background: linear-gradient(135deg, var(--primary-600), var(--primary-700));
}

.pagination-btn:active {
    transform: translateY(0);
    box-shadow: var(--shadow-sm);
}

.pagination-btn i {
    font-size: var(--text-sm);
}

.pagination-info {
    font-size: var(--text-base);
    color: var(--secondary-600);
    font-weight: var(--font-semibold);
    background: var(--white);
    padding: var(--space-md) var(--space-xl);
    border-radius: var(--radius-lg);
    border: 2px solid var(--secondary-100);
    box-shadow: var(--shadow-sm);
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    min-width: 140px;
    justify-content: center;
}

.pagination-info::before {
    content: 'üìÑ';
    font-size: var(--text-lg);
}

/* Empty & Error States */
.empty-history, .error-history {
    min-height: 300px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, var(--secondary-50), var(--white));
    border-radius: var(--radius-xl);
    margin: var(--space-xl) 0;
    border: 1px solid var(--secondary-100);
}

.empty-state-content, .error-state-content {
    text-align: center;
    padding: var(--space-4xl) var(--space-xl);
    color: var(--secondary-500);
    max-width: 320px;
}

.empty-state-content .icon, .error-state-content .icon {
    font-size: 4rem;
    margin-bottom: var(--space-xl);
    opacity: 0.6;
    display: block;
    animation: float 3s ease-in-out infinite;
}

.empty-state-content h3, .error-state-content h3 {
    font-size: var(--text-xl);
    font-weight: var(--font-semibold);
    color: var(--secondary-700);
    margin-bottom: var(--space-md);
}

.empty-state-content p, .error-state-content p {
    font-size: var(--text-base);
    color: var(--secondary-500);
    margin-bottom: var(--space-lg);
    line-height: 1.6;
}

.retry-btn {
    padding: var(--space-md) var(--space-xl);
    background: var(--gradient-primary);
    color: var(--white);
    border: none;
    border-radius: var(--radius-lg);
    cursor: pointer;
    font-size: var(--text-base);
    font-weight: var(--font-semibold);
    font-family: 'Prompt', sans-serif;
    transition: all 0.3s ease;
    box-shadow: var(--shadow-sm);
    display: inline-flex;
    align-items: center;
    gap: var(--space-sm);
}

.retry-btn:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
}

.retry-btn i {
    font-size: var(--text-sm);
}

/* Loading Animation */
.history-loading {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: var(--space-4xl);
    background: linear-gradient(135deg, var(--secondary-50), var(--white));
    border-radius: var(--radius-xl);
    margin: var(--space-xl) 0;
    border: 1px solid var(--secondary-100);
}

.history-loading .spinner {
    width: 48px;
    height: 48px;
    border: 4px solid var(--secondary-100);
    border-top: 4px solid var(--primary-500);
    border-radius: var(--radius-full);
    animation: spin 1s linear infinite;
    margin-bottom: var(--space-xl);
}

.history-loading p {
    font-size: var(--text-lg);
    color: var(--secondary-600);
    font-weight: var(--font-medium);
}

/* Animations */
@keyframes float {
    0%, 100% { transform: translateY(0px); }
    50% { transform: translateY(-10px); }
}

/* Responsive */
@media (max-width: 480px) {
    .pagination-container {
        flex-direction: column;
        gap: var(--space-md);
        padding: var(--space-lg);
    }
    
    .pagination-btn {
        width: 100%;
        max-width: 200px;
        padding: var(--space-lg) var(--space-xl);
        font-size: var(--text-lg);
    }
    
    .pagination-info {
        order: -1;
        margin-bottom: var(--space-sm);
        width: 100%;
        max-width: 200px;
    }
    
    .history-item {
        padding: var(--space-lg) var(--space-md);
        margin-bottom: var(--space-md);
    }
    
    .history-header {
        flex-direction: column;
        align-items: flex-start;
        gap: var(--space-md);
    }
    
    .history-title {
        font-size: var(--text-lg);
    }
    
    .history-food {
        font-size: var(--text-base);
    }
}

/* =================================
   üí´ LOADING & STATES
   ================================= */

.loading-screen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: var(--gradient-primary);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    color: var(--white);
}

.loading-image img {
    border-radius: 10%;
    animation: bounce 2s infinite;
    position: relative;
    left: -20px;
}

.loading-text {
    font-size: var(--text-2xl);
    font-weight: var(--font-medium);
    text-align: center;
}

.loading, .empty-state {
    text-align: center;
    padding: var(--space-4xl) var(--space-xl);
    color: var(--secondary-500);
}

.spinner {
    width: 36px;
    height: 36px;
    border: 3px solid var(--secondary-100);
    border-top: 3px solid var(--primary-500);
    border-radius: var(--radius-full);
    animation: spin 1s linear infinite;
    margin: 0 auto var(--space-lg);
}

.empty-state i {
    font-size: 2.5rem;
    margin-bottom: var(--space-lg);
    opacity: 0.4;
}

/* Highlight */
.highlight {
    background: linear-gradient(135deg, var(--warning-400), var(--warning-500));
    color: #92400e;
    padding: var(--space-xs) var(--space-xs);
    border-radius: var(--space-xs);
    font-weight: var(--font-bold);
    text-shadow: 0 1px 2px rgba(146, 64, 14, 0.1);
    box-shadow: 0 1px 3px rgba(251, 191, 36, 0.3);
}

/* =================================
   üé≠ ANIMATIONS
   ================================= */

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

@keyframes bounce {
    0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
    40% { transform: translateY(-10px); }
    60% { transform: translateY(-5px); }
}

@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.2); }
}

@keyframes shimmer {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* =================================
   üì± RESPONSIVE - TABLET & DESKTOP
   (Mobile-first approach)
   ================================= */

/* Tablet: 768px+ */
@media (min-width: 768px) {
    :root {
        --text-base: 1rem;
        --text-lg: 1.125rem;
        --text-xl: 1.25rem;
        --text-2xl: 1.5rem;
        --text-3xl: 2.25rem;
        --text-4xl: 2.75rem;
        --container-padding: var(--space-xl);
    }
    
    .logo {
        width: 140px;
        height: 140px;
    }
    
    .header-text h1 {
        font-size: var(--text-2xl);
    }
    
    .header-text p {
        font-size: var(--text-base);
    }
    
    .points-card {
        margin: var(--space-xl) var(--space-xl);
        padding: var(--space-3xl) var(--space-2xl);
    }
    
    .profile-avatar {
        width: 90px;
        height: 90px;
        font-size: var(--text-2xl);
    }
    
    .gift-slide {
        padding: var(--space-xl) var(--space-lg);
    }
    
    .gift-content {
        gap: var(--space-2xl);
    }
    
    .gift-icon-large {
        width: 80px;
        height: 80px;
        font-size: var(--text-3xl);
    }
    
    .gift-icon-large img {
        width: 56px;
        height: 56px;
    }
    
    .gift-name-large {
        font-size: var(--text-xl);
    }
    
    .gift-points-large {
        font-size: var(--text-lg);
    }
    
    .gift-button-large {
        padding: var(--space-lg) var(--space-2xl);
        font-size: var(--text-base);
        min-width: 100px;
        min-height: 48px;
    }
    
    .milestone-dot {
        width: 32px;
        height: 32px;
        font-size: var(--text-base);
    }
    
    .carousel-indicators {
        margin: var(--space-xl) 0;
    }
    
    .indicator-dot {
        width: 8px;
        height: 8px;
    }
}

/* Desktop: 1024px+ */
@media (min-width: 1024px) {
    .app-container {
        box-shadow: var(--shadow-xl);
    }
    
    .gift-slide {
        padding: var(--space-lg);
    }
    
    .gift-content {
        gap: var(--space-2xl);
    }
}

/* =================================
   üîß UTILITY CLASSES
   ================================= */

.sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
}

.text-center { text-align: center; }
.text-left { text-align: left; }
.text-right { text-align: right; }

.font-bold { font-weight: var(--font-bold); }
.font-semibold { font-weight: var(--font-semibold); }
.font-medium { font-weight: var(--font-medium); }

.text-primary { color: var(--primary-500); }
.text-secondary { color: var(--secondary-500); }
.text-success { color: var(--success-500); }
.text-warning { color: var(--warning-500); }
.text-error { color: var(--error-500); }

.hidden { display: none; }
.block { display: block; }
.flex { display: flex; }
.inline-flex { display: inline-flex; }

.items-center { align-items: center; }
.justify-center { justify-content: center; }
.justify-between { justify-content: space-between; }

.w-full { width: 100%; }
.h-full { height: 100%; }

.mb-2 { margin-bottom: var(--space-sm); }
.mb-4 { margin-bottom: var(--space-lg); }
.mt-2 { margin-top: var(--space-sm); }
.mt-4 { margin-top: var(--space-lg); }

.p-2 { padding: var(--space-sm); }
.p-4 { padding: var(--space-lg); }
.px-4 { padding-left: var(--space-lg); padding-right: var(--space-lg); }
.py-2 { padding-top: var(--space-sm); padding-bottom: var(--space-sm); }

.rounded { border-radius: var(--radius-md); }
.rounded-lg { border-radius: var(--radius-lg); }
.rounded-full { border-radius: var(--radius-full); }

.shadow { box-shadow: var(--shadow-md); }
.shadow-lg { box-shadow: var(--shadow-lg); }
</style>

</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-image">
            <img src="https://raw.githubusercontent.com/HappyWorkPlace/BurnFatForAll/ddf3d033498384b6bc2bfa2a94164182b851ea0e/picture/Emo-1.png" alt="Loading" style="width: 200px; height: 200px; margin-bottom: 10px;">
        </div>
        <div class="loading-text">
            <div>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</div>
            <div style="font-size: 0.9rem; margin-top: 10px; opacity: 0.8;">‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...</div>
        </div>
    </div>

    <div class="app-container">
        <!-- Header -->
        <div class="header">
            <div class="logo-section">
                <div class="logo">
                    <img src="https://raw.githubusercontent.com/HappyWorkPlace/BurnFatForAll/5839a19670212ff1c280dcc98c945503d9004c37/Logo_healthylife2.png" alt="Logo">
                </div>
                <div class="header-text">
                    <h1>‡∏Å‡∏¥‡∏ô‡∏î‡∏µ Healthy Life #2</h1>
                    <p>Happy Work Place : Happy Body</p>
                    <p>NMB Minebea Thai</p>
                </div>
            </div>
        </div>

        <!-- Points Card -->
        <div class="points-card">
            <div class="card-top-section">
                <div class="member-header">
                    <div class="profile-avatar" id="profileAvatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="member-info">
                        <div class="member-name" id="memberName">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
                        <div class="member-dept" id="memberDept">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
                        <div class="member-badge" id="memberBadge">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
                    </div>
                </div>
                
                <div class="points-section">
                    <div class="points-value" id="pointsValue">0</div>
                    <div class="points-label">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏∞‡∏™‡∏°</div>
                </div>
            </div>
            
            <!-- Progress Section -->
            <div class="progress-section">
                <div class="milestones-progress">
                    <div class="progress-track">
                        <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
                    </div>
                    
                    <div class="milestones">
                        <div class="milestone">
                            <div class="milestone-dot">
                                <i class="fas fa-box-tissue milestone-icon"></i>
                            </div>
                            <div class="milestone-label">30</div>
                        </div>
                        <div class="milestone">
                            <div class="milestone-dot">
                                <i class="fas fa-umbrella milestone-icon"></i>
                            </div>
                            <div class="milestone-label">60</div>
                        </div>
                        <div class="milestone">
                            <div class="milestone-dot">
                                <i class="fas fa-box milestone-icon"></i>
                            </div>
                            <div class="milestone-label">90</div>
                        </div>
                        <div class="milestone">
                            <div class="milestone-dot">
                                <i class="fas fa-shopping-bag milestone-icon"></i>
                            </div>
                            <div class="milestone-label">120</div>
                        </div>
                        <div class="milestone">
                            <div class="milestone-dot">
                                <i class="fas fa-glass-water milestone-icon"></i>
                            </div>
                            <div class="milestone-label">150</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gifts Carousel -->
            <div class="gifts-carousel">
                <div class="gifts-container" id="giftsContainer">
                    <!-- Gift Level 30 -->
                    <div class="gift-slide">
                        <div class="gift-content">
                            <div class="gift-icon-large">
                                <img src="https://raw.githubusercontent.com/HappyWorkPlace/BurnFatForAll/3c0d58a21a12b84403f0cf191bcf88fac2a54034/picture/15.png"
                                     alt="‡∏ó‡∏¥‡∏ä‡∏ä‡∏π‡πà‡∏Ñ‡∏∏‡∏°‡∏∞">
                            </div>
                            <div class="gift-details">
                                <div class="gift-name-large">‡∏ó‡∏¥‡∏ä‡∏ä‡∏π‡πà‡∏Ñ‡∏∏‡∏°‡∏∞</div>
                                <div class="gift-points-large">30 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div>
                                <div class="gift-stock-large">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ <span id="gift30-balance">25</span> ‡∏ä‡∏¥‡πâ‡∏ô</div>
                            </div>
                        </div>
                        <div class="gift-action">
                            <button class="gift-button-large" id="gift30" disabled>‡πÅ‡∏•‡∏Å‡∏£‡∏±‡∏ö</button>
                        </div>
                    </div>

                    <!-- Gift Level 60 -->
                    <div class="gift-slide">
                        <div class="gift-content">
                            <div class="gift-icon-large">
                                <img src="https://raw.githubusercontent.com/HappyWorkPlace/BurnFatForAll/32eb73075e8460c39473dc919d86ab725f9509e8/picture/umbrella.png" 
                                     alt="‡∏£‡πà‡∏°‡∏¢‡∏≤‡∏ß‡∏Ñ‡∏•‡∏∞‡∏™‡∏µ">
                            </div>
                            <div class="gift-details">
                                <div class="gift-name-large">‡∏£‡πà‡∏°‡∏¢‡∏≤‡∏ß‡∏Ñ‡∏•‡∏∞‡∏™‡∏µ</div>
                                <div class="gift-points-large">60 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div>
                                <div class="gift-stock-large">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ <span id="gift60-balance">15</span> ‡∏ä‡∏¥‡πâ‡∏ô</div>
                            </div>
                        </div>
                        <div class="gift-action">
                            <button class="gift-button-large" id="gift60" disabled>‡πÅ‡∏•‡∏Å‡∏£‡∏±‡∏ö</button>
                        </div>
                    </div>

                    <!-- Gift Level 90 -->
                    <div class="gift-slide">
                        <div class="gift-content">
                            <div class="gift-icon-large">
                                <img src="https://raw.githubusercontent.com/HappyWorkPlace/BurnFatForAll/3c0d58a21a12b84403f0cf191bcf88fac2a54034/picture/45.png"
                                     alt="‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£">
                            </div>
                            <div class="gift-details">
                                <div class="gift-name-large">‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£ Superlock</div>
                                <div class="gift-points-large">90 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div>
                                <div class="gift-stock-large">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ <span id="gift90-balance">8</span> ‡∏ä‡∏¥‡πâ‡∏ô</div>
                            </div>
                        </div>
                        <div class="gift-action">
                            <button class="gift-button-large" id="gift90" disabled>‡πÅ‡∏•‡∏Å‡∏£‡∏±‡∏ö</button>
                        </div>
                    </div>

                    <!-- Gift Level 120 -->
                    <div class="gift-slide">
                        <div class="gift-content">
                            <div class="gift-icon-large">
                                <img src="https://raw.githubusercontent.com/HappyWorkPlace/BurnFatForAll/3c0d58a21a12b84403f0cf191bcf88fac2a54034/picture/bag-reward.png"
                                     alt="‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡∏Å‡∏¥‡∏ô‡∏î‡∏µ">
                            </div>
                            <div class="gift-details">
                                <div class="gift-name-large">‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡∏ú‡πâ‡∏≤‡∏Å‡∏¥‡∏ô‡∏î‡∏µHealthyLife</div>
                                <div class="gift-points-large">120 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div>
                                <div class="gift-stock-large">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ <span id="gift120-balance">5</span> ‡∏ä‡∏¥‡πâ‡∏ô</div>
                            </div>
                        </div>
                        <div class="gift-action">
                            <button class="gift-button-large" id="gift120" disabled>‡πÅ‡∏•‡∏Å‡∏£‡∏±‡∏ö</button>
                        </div>
                    </div>

                    <!-- Gift Level 150 -->
                    <div class="gift-slide">
                        <div class="gift-content">
                            <div class="gift-icon-large">
                                <img src="https://raw.githubusercontent.com/HappyWorkPlace/BurnFatForAll/3c0d58a21a12b84403f0cf191bcf88fac2a54034/picture/75.png"
                                     alt="‡πÅ‡∏Å‡πâ‡∏ß Locknlock">
                            </div>
                            <div class="gift-details">
                                <div class="gift-name-large">‡πÅ‡∏Å‡πâ‡∏ßLocknlock</div>
                                <div class="gift-points-large">150 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div>
                                <div class="gift-stock-large">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ <span id="gift150-balance">2</span> ‡∏ä‡∏¥‡πâ‡∏ô</div>
                            </div>
                        </div>
                        <div class="gift-action">
                            <button class="gift-button-large" id="gift150" disabled>‡πÅ‡∏•‡∏Å‡∏£‡∏±‡∏ö</button>
                        </div>
                    </div>
                </div>
                
                <div class="carousel-indicators">
                    <div class="indicator-dot active" onclick="scrollToGift(0)"></div>
                    <div class="indicator-dot" onclick="scrollToGift(1)"></div>
                    <div class="indicator-dot" onclick="scrollToGift(2)"></div>
                    <div class="indicator-dot" onclick="scrollToGift(3)"></div>
                    <div class="indicator-dot" onclick="scrollToGift(4)"></div>
                </div>
            </div>
        </div>

        <!-- Navigation -->
        <div class="nav-container">
            <div class="nav-tabs">
                <button class="nav-tab active" onclick="switchTab('record')">
                    <i class="fas fa-utensils"></i>
                    <span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</span>
                </button>
                <button class="nav-tab" onclick="switchTab('history')">
                    <i class="fas fa-history"></i>
                    <span>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</span>
                </button>
            </div>
        </div>

        <!-- Content -->
        <div class="content">
            <!-- Food Recording -->
            <div id="recordSection" class="section active">
                <div class="search-container">
                    <input type="text" class="search-input" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏°‡∏ô‡∏π‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å‡πÇ‡∏£‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£..." id="foodSearch">
                    <i class="fas fa-search search-icon"></i>
                    <div class="dropdown-list" id="foodDropdown">
                        <!-- Food items will be loaded dynamically -->
                    </div>
                </div>
                <button class="record-button btn-primary" id="recordBtn" disabled>
                    <i class="fas fa-save"></i> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏°‡∏ô‡∏π‡∏Å‡πà‡∏≠‡∏ô
                </button>
            </div>

            <!-- History -->
            <div id="historySection" class="section">
                <div class="loading" id="historyLoading">
                    <div class="spinner"></div>
                    <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥...</p>
                </div>
                <div id="historyList">
                    <!-- History items will be loaded dynamically -->
                </div>
            </div>
        </div>
    </div>


<script>
/* =================================
   ‚öôÔ∏è CONSTANTS & CONFIGURATION
   ================================= */
const CONFIG = {
    LIFF_ID: '2004752543-O6bmBeMw',
    API_URL: 'https://script.google.com/macros/s/AKfycbz5i0Xp6HXqm9gmnraGzkgFoQOLY2ub6qEthUOFRn7yoLabUd3vkfl2VimiEqar_W8/exec',
    GIFT_LEVELS: [30, 60, 90, 120, 150],
    MILESTONE_VALUES: [30, 60, 90, 120, 150],
    RECORDS_PER_PAGE: 5,
    AUTO_SCROLL_INTERVAL: 5000,
    INIT_TIMEOUT: 10000
};

const GIFT_COLUMN_MAP = {
    30: 6,   // Column G
    60: 7,   // Column H  
    90: 8,   // Column I
    120: 9,  // Column J
    150: 10  // Column K
};

const MESSAGES = {
    LOADING: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...',
    LIFF_ERROR: '‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏≠‡∏õ‡πÉ‡∏ô LINE',
    NETWORK_ERROR: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ',
    FOOD_REQUIRED: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡∏≤‡∏´‡∏≤‡∏£',
    ALREADY_RECORDED: '‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∏‡∏ì‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ‡∏Ñ‡πà‡∏≠‡∏¢‡∏°‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏ô‡∏∞',
    INSUFFICIENT_POINTS: '‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠',
    OUT_OF_STOCK: '‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß',
    SUCCESS_RECORD: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß +1 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô',
    SUCCESS_REDEEM: '‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!'
};

/* =================================
   üåê GLOBAL VARIABLES
   ================================= */
let userPoints = 0;
let selectedFood = '';
let currentUserData = null;
let userData = null;
let validFoodList = [];
let giftListData = [];
let userGiftStatus = {};

// UI State
let autoScrollInterval = null;
let currentGiftIndex = 0;
let userInteracted = false;
let isSubmitting = false;

// History Pagination
let historyData = [];
let currentPage = 1;

/* =================================
   üîß UTILITY FUNCTIONS
   ================================= */
const Utils = {
    // Date formatting
    formatDateTime(timestamp) {
        if (!timestamp) return '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏ß‡∏•‡∏≤';
        
        try {
            const date = new Date(timestamp);
            const dateStr = date.toLocaleDateString('th-TH', {
                year: 'numeric',
                month: '2-digit', 
                day: '2-digit'
            });
            const timeStr = date.toLocaleTimeString('th-TH', {
                hour: '2-digit',
                minute: '2-digit'
            });
            return `${dateStr} ${timeStr}`;
        } catch (error) {
            console.error('Error formatting date:', error);
            return '‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
        }
    },

    // Text highlighting
    highlightText(text, keyword) {
        if (!keyword || keyword.trim() === '') return text;
        
        const escapedKeyword = keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\');
        const regex = new RegExp(`(${escapedKeyword})`, 'gi');
        return text.replace(regex, '<span class="highlight">$1</span>');
    },

    // Check URL parameters
    getUrlParams() {
        return new URLSearchParams(window.location.search);
    },

    // Show loading state
    showLoading(element, message = MESSAGES.LOADING) {
        if (element) {
            element.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>${message}</p>
                </div>
            `;
        }
    },

    // Progress calculation
    calculateProgress(points) {
        if (points > 150) return 100;
        
        for (let i = 0; i < CONFIG.MILESTONE_VALUES.length; i++) {
            if (points <= CONFIG.MILESTONE_VALUES[i]) {
                const prevMilestone = i === 0 ? 0 : CONFIG.MILESTONE_VALUES[i - 1];
                const currentMilestone = CONFIG.MILESTONE_VALUES[i];
                const segmentProgress = (points - prevMilestone) / (currentMilestone - prevMilestone);
                const baseProgress = (i / CONFIG.MILESTONE_VALUES.length) * 100;
                const segmentWidth = (1 / CONFIG.MILESTONE_VALUES.length) * 100;
                return baseProgress + (segmentProgress * segmentWidth);
            }
        }
        return 0;
    },

    // Check if all required data is loaded
    isDataReady() {
        return !!(
            userData && Array.isArray(userData) && userData.length > 0 &&
            validFoodList && validFoodList.length > 0 &&
            giftListData && giftListData.length > 0
        );
    },

    // Safe data access
    safeDataAccess(callback, fallback = null) {
        try {
            if (this.isDataReady()) {
                return callback();
            } else {
                console.warn('Data not ready, using fallback');
                return fallback;
            }
        } catch (error) {
            console.error('Error in safe data access:', error);
            return fallback;
        }
    }
};

/* =================================
   üåê API FUNCTIONS (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß)
   ================================= */
const API = {
    // Base fetch with error handling
    async request(params) {
        const url = `${CONFIG.API_URL}?${new URLSearchParams(params)}`;
        
        try {
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return await response.json();
        } catch (error) {
            console.error('API request failed:', error);
            throw error;
        }
    },

    // Get user data
    async getUserData(uid) {
        return this.request({ action: 'getUserData2', uid });
    },

    // ‚≠ê ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà: ‡∏≠‡πà‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå JSON
    async getFoodListFromFile() {
        try {
            const response = await fetch('./foodlist.json');
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return await response.json();
        } catch (error) {
            console.error('Failed to load food list from file:', error);
            throw error;
        }
    },

    // ‚ö†Ô∏è ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏Å‡πà‡∏≤ - ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÄ‡∏õ‡πá‡∏ô backup
    // async getFoodList() {
    //     return this.request({ 
    //         action: 'getFoodList', 
    //         sheetName: 'MENU', 
    //         column: 'A' 
    //     });
    // },

    // Check if user already recorded today
// ‚≠ê ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡πÄ‡∏ä‡πá‡∏Ñ‡∏à‡∏≤‡∏Å userData[12] ‡πÅ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API
    async checkUserColumnJ(uid) {
    try {
        // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏à‡∏≤‡∏Å userData[12] ‡πÅ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API
        if (!userData || !Array.isArray(userData) || userData.length < 13) {
            throw new Error('User data not available');
        }
        
        const todayRecorded = userData[12]; // "TRUE" ‡∏´‡∏£‡∏∑‡∏≠ "FALSE"
        
        // ‚≠ê ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢
        let recordedTime = null;
        try {
            if (userData[13]) {
                // ‡∏ñ‡πâ‡∏≤ userData[13] ‡πÄ‡∏õ‡πá‡∏ô Date object
                if (userData[13] instanceof Date) {
                    recordedTime = userData[13].toISOString();
                }
                // ‡∏ñ‡πâ‡∏≤ userData[13] ‡πÄ‡∏õ‡πá‡∏ô string ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
                else if (typeof userData[13] === 'string') {
                    recordedTime = new Date(userData[13]).toISOString();
                }
                // ‡∏ñ‡πâ‡∏≤ userData[13] ‡πÄ‡∏õ‡πá‡∏ô timestamp
                else if (typeof userData[13] === 'number') {
                    recordedTime = new Date(userData[13]).toISOString();
                }
            }
        } catch (timeError) {
            console.log('‚ö†Ô∏è Cannot parse time from userData[13]:', userData[13]);
            recordedTime = new Date().toISOString(); // ‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÄ‡∏õ‡πá‡∏ô fallback
        }
        
        // ‚≠ê ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Logic ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
        if (todayRecorded === "TRUE") {
            return {
                success: true,
                status: 'TRUE', // ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ
                message: 'Can record today'
            };
        } else {
            return {
                success: true,
                status: 'FALSE', // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß
                message: 'Already recorded today',
                lastTimestamp: recordedTime || new Date().toISOString()
            };
        }
    } catch (error) {
        console.error('Error checking user status from userData:', error);
        
        // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Å‡∏¥‡∏î error ‡πÉ‡∏´‡πâ fallback ‡πÑ‡∏õ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API ‡∏à‡∏£‡∏¥‡∏á
        console.log('üîÑ Fallback: ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API checkUserColumnJ...');
        return this.request({ action: 'checkUserColumnJ', uid });
    }
},

    // Save food record
    async saveRedeemData(empNo, factory, selectedFood, name) {
        console.log('üçΩÔ∏è Starting saveRedeemData:', { empNo, factory, selectedFood, name });
        
        // Validate parameters
        if (!empNo || !factory || !selectedFood || !name) {
            throw new Error('Missing required parameters for saveRedeemData');
        }
        
        const params = { 
            action: 'saveRedeemData',
            empNo: String(empNo).trim(),
            factory: String(factory).trim(),
            selectedFood: String(selectedFood).trim(),
            name: String(name).trim()
        };

    // Get gift list
    async getGiftList() {
        return this.request({ action: 'getGiftList' });
    },

    // Get user data for gifts (legacy API)
    async getUserDataForGifts(uid) {
        return this.request({ action: 'getUserData', uid });
    },

    // Redeem gift
    async redeemGift(uid, level) {
        return this.request({ action: 'redeemGift', uid, level });
    },

    // Get user records history
    async getUserRecords(uid) {
        return this.request({ action: 'getUserRecords', uid });
    }
};

/* =================================
   üì± LIFF & AUTHENTICATION
   ================================= */
const LIFF = {
    async initialize() {
        console.log('Initializing LIFF...');
        
        // Check for registration success
        const urlParams = Utils.getUrlParams();
        if (urlParams.get('registered') === 'success') {
            window.history.replaceState({}, document.title, window.location.pathname);
            setTimeout(() => {
                Swal.fire({
                    title: '‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö!',
                    text: '‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß',
                    icon: 'success',
                    confirmButtonColor: '#10b981',
                    timer: 2000
                });
            }, 1000);
        }
        
        if (typeof liff === 'undefined') {
            console.error('LIFF SDK is not defined');
            this.handleError('LIFF SDK ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
            return;
        }
        
        // Set initialization timeout
        const timeoutPromise = new Promise((_, reject) => {
            setTimeout(() => reject(new Error('LIFF initialization timeout')), CONFIG.INIT_TIMEOUT);
        });
        const liffPromise = liff.init({ liffId: CONFIG.LIFF_ID });
        
        try {
            await Promise.race([liffPromise, timeoutPromise]);
            console.log('LIFF initialized successfully');
            
            if (liff.isLoggedIn()) {
                console.log('User is logged in, getting profile');
                await this.getUserProfile();
            } else {
                console.log('User is not logged in, redirecting to login');
                liff.login();
            }
        } catch (error) {
            console.error('LIFF Initialization failed:', error);
            this.handleError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE ‡πÑ‡∏î‡πâ');
        }
    },

    async getUserProfile() {
        try {
            const profile = await liff.getProfile();
            console.log('Profile obtained:', profile);
            
            const { userId: uid, displayName, pictureUrl } = profile;
            
            // Update avatar
            UI.updateUserAvatar(displayName, pictureUrl);
            
            // Fetch user data
            await User.loadUserData(uid, displayName);
        } catch (error) {
            console.error('Failed to get user profile:', error);
            this.handleError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå LINE ‡πÑ‡∏î‡πâ');
        }
    },

    handleError(message) {
        console.error('LIFF Error:', message);
        UI.hideLoadingScreen();
        
        // ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤ error ‡πÅ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£ popup
        this.showErrorPage(message);
    },

    showErrorPage(message) {
        const app = document.getElementById('app');
        if (app) {
            app.innerHTML = `
                <div class="error-container">
                    <div class="error-content">
                        <div class="error-icon">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <h2>‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ</h2>
                        <p class="error-message">${message}</p>
                        <div class="error-instructions">
                            <h4>‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç:</h4>
                            <ul>
                                <li>‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏≠‡∏õ‡πÉ‡∏ô LINE Browser</li>
                                <li>‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï</li>
                                <li>‡∏•‡∏≠‡∏á‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡∏°‡πà</li>
                            </ul>
                        </div>
                        <button class="retry-button" onclick="location.reload()">
                            <i class="fas fa-redo-alt"></i>
                            ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà
                        </button>
                    </div>
                </div>
                
                <style>
                .error-container {
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    min-height: 100vh;
                    padding: 20px;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                }
                
                .error-content {
                    background: white;
                    padding: 40px 30px;
                    border-radius: 16px;
                    box-shadow: 0 20px 60px rgba(0,0,0,0.1);
                    text-align: center;
                    max-width: 400px;
                    width: 100%;
                }
                
                .error-icon {
                    font-size: 60px;
                    color: #f59e0b;
                    margin-bottom: 20px;
                }
                
                .error-content h2 {
                    color: #1f2937;
                    margin-bottom: 15px;
                    font-size: 24px;
                }
                
                .error-message {
                    color: #6b7280;
                    margin-bottom: 25px;
                    font-size: 16px;
                }
                
                .error-instructions {
                    background: #f9fafb;
                    padding: 20px;
                    border-radius: 12px;
                    margin-bottom: 25px;
                    text-align: left;
                }
                
                .error-instructions h4 {
                    color: #374151;
                    margin-bottom: 10px;
                    font-size: 16px;
                }
                
                .error-instructions ul {
                    color: #6b7280;
                    margin: 0;
                    padding-left: 20px;
                }
                
                .error-instructions li {
                    margin-bottom: 5px;
                    font-size: 14px;
                }
                
                .retry-button {
                    background: #10b981;
                    color: white;
                    border: none;
                    padding: 12px 24px;
                    border-radius: 8px;
                    font-size: 16px;
                    cursor: pointer;
                    display: inline-flex;
                    align-items: center;
                    gap: 8px;
                    transition: background-color 0.2s;
                }
                
                .retry-button:hover {
                    background: #059669;
                }
                
                .retry-button i {
                    font-size: 14px;
                }
                </style>
            `;
        }
    }
};

/* =================================
   üë§ USER MANAGEMENT
   ================================= */
const User = {
    async loadUserData(uid, displayName) {
        console.log('Fetching user data for UID:', uid);
        
        try {
            const response = await API.getUserData(uid);
            console.log('User data:', response);
            
            if (response.error) {
                // User not found - redirect to register
                this.redirectToRegister();
            } else {
                // User found - display data
                this.displayUserData(response.data, displayName);
            }
        } catch (error) {
            console.error('Error fetching user data:', error);
            UI.showErrorAndHideLoading('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ');
        }
    },

    displayUserData(userDataResponse, displayName) {
        console.log('Displaying user data:', userDataResponse);
        
        currentUserData = userDataResponse;
        userData = userDataResponse;
        
        // Parse userData - handle array or object
        let parsedData = {};
        if (Array.isArray(userDataResponse)) {
            parsedData = {
                Name: userDataResponse[2] || displayName,
                Division: userDataResponse[3] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡πÅ‡∏ú‡∏ô‡∏Å',
                Factory: userDataResponse[4] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô', 
                Point: userDataResponse[5] || 0
            };
        } else {
            parsedData = userDataResponse;
        }
        
        console.log('Parsed user data:', parsedData);
        
        // Update UI
        UI.updateUserInfo(displayName, parsedData);
        
        // Update points
        userPoints = parseInt(parsedData.Point) || 0;
        UI.updatePointsDisplay(userPoints);
        
        // Load data sequentially to avoid race conditions
        this.loadInitialData();
    },

    async loadInitialData() {
        try {
            console.log('Starting sequential data loading...');
            
            // Step 1: Load food list first
            await Food.loadFoodList();
            console.log('Food list loaded successfully');
            
            // Step 2: Load gift data  
            await Gift.loadGiftData();
            console.log('Gift data loaded successfully');
            
            // Step 3: Update gift buttons after all data is ready
            Gift.updateGiftButtons(userPoints);
            console.log('Gift buttons updated');
            
            // Step 4: Start UI features
            UI.startAutoScroll();
            UI.hideLoadingScreen();
            
            console.log('All initialization completed successfully');
            
        } catch (error) {
            console.error('Error during sequential data loading:', error);
            UI.hideLoadingScreen();
            
            // Show user-friendly error
            Swal.fire({
                title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
                text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á',
                icon: 'error',
                confirmButtonText: '‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà',
                confirmButtonColor: '#10b981'
            }).then((result) => {
                if (result.isConfirmed) {
                    location.reload();
                }
            });
        }
    },

    redirectToRegister() {
        UI.hideLoadingScreen();
        window.location.href = 'https://happyworkplace.github.io/BurnFatForAll/register';
    }
};

/* =================================
   üçΩÔ∏è FOOD SYSTEM
   ================================= */
const Food = {
    async loadFoodList() {
        try {
            console.log('Loading food list...');
            const response = await API.getFoodListFromFile();
            
            if (response.success) {
                validFoodList = response.data.filter(food => 
                    food && food.trim() !== '' && food !== '-'
                );
                console.log('‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:', validFoodList.length, '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
                this.populateDropdown(validFoodList);
                return validFoodList;
            } else {
                throw new Error('Failed to fetch food list');
            }
        } catch (error) {
            console.error('Error fetching food list:', error);
            validFoodList = [];
            this.populateDropdown(validFoodList);
            throw error; // Re-throw to let the caller handle it
        }
    },

    populateDropdown(foodList) {
        const dropdownList = document.getElementById('foodDropdown');
        if (!dropdownList) return;
        
        dropdownList.innerHTML = '';
        
        foodList.forEach(food => {
            const item = document.createElement('div');
            item.className = 'dropdown-item';
            item.textContent = food;
            dropdownList.appendChild(item);
        });
    },

    validateFood(foodName) {
        if (!foodName || foodName.trim() === '') {
            return {
                isValid: false,
                message: '',
                showIcon: false
            };
        }

        const trimmedFood = foodName.trim();
        const isValid = validFoodList.some(food => 
            food.toLowerCase() === trimmedFood.toLowerCase()
        );

        return {
            isValid,
            message: isValid ? '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‚úì' : '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥',
            showIcon: true
        };
    },

    async recordSelection() {
        if (isSubmitting) {
            console.log('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏¢‡∏π‡πà ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠...');
            return;
        }

        if (!userData || !selectedFood) {
            Swal.fire({
                title: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡∏≤‡∏´‡∏≤‡∏£',
                text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏°‡∏ô‡∏π‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å',
                icon: 'warning',
                confirmButtonColor: '#10b981'
            });
            return;
        }

        const validation = this.validateFood(selectedFood);
        if (!validation.isValid) {
            Swal.fire({
                title: '‡πÄ‡∏°‡∏ô‡∏π‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á',
                text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏°‡∏ô‡∏π‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô',
                icon: 'error',
                confirmButtonColor: '#10b981'
            });
            return;
        }

        isSubmitting = true;
        UI.updateRecordButton(selectedFood);

        Swal.fire({
            title: '‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏õ‡∏£‡∏∂‡∏¢‡∏±‡∏á‡∏ô‡πâ‡∏≤...',
            text: '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà..',
            allowOutsideClick: false,
            didOpen: () => Swal.showLoading()
        });

        try {
            const profile = await liff.getProfile();
            const uid = profile.userId;
            await this.checkAndSave(uid, userData[1], userData[4], selectedFood, userData[2]);
        } catch (error) {
            console.error('Failed to get user profile:', error);
            this.resetSubmitting();
            Swal.fire('Error', 'Failed to get user profile. Please try again later.', 'error');
        }
    },

    async checkAndSave(uid, empNo, factory, selectedFood, name) {
        try {
            const response = await API.checkUserColumnJ(uid);
            Swal.close();
            
            if (response.status === 'TRUE') {
                await this.saveSelection(empNo, factory, selectedFood, uid, name);
            } else if (response.status === 'FALSE') {
                this.resetSubmitting();
                Swal.fire({
                    title: '‡πÅ‡∏¢‡πà‡∏à‡∏±‡∏á..',
                    html: `‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∏‡∏ì‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏°‡∏∑‡πà‡∏≠ ${new Date(response.lastTimestamp).toLocaleString()} ‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ‡∏Ñ‡πà‡∏≠‡∏¢‡∏°‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏ô‡∏∞ <br><img src="https://raw.githubusercontent.com/HappyWorkPlace/BurnFatForAll/main/picture/healthy-food_error.png" alt="icon" style="width:100px;height:100px;">`
                });
            } else {
                this.resetSubmitting();
                Swal.fire('Error', 'Failed to check user status.', 'error');
            }
        } catch (error) {
            console.error('Error checking user status:', error);
            this.resetSubmitting();
            Swal.fire('Error', 'Failed to check user status. Please try again later.', 'error');
        }
    },

    async saveSelection(empNo, factory, selectedFood, uid, name) {
        Swal.fire({
            title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
            text: '‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà..',
            allowOutsideClick: false,
            didOpen: () => Swal.showLoading()
        });

        try {
            const response = await API.saveRedeemData(empNo, factory, selectedFood, name);
            Swal.close();
            
            if (response.success) {
                // Add points and update UI
                userPoints += 1;
                UI.updatePointsDisplay(userPoints);
                
                Swal.fire({
                    title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                    html: '<img src="https://raw.githubusercontent.com/HappyWorkPlace/BurnFatForAll/main/picture/healthy-food_1.png" alt="success" style="width:100px;height:100px;"><p>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß</p>',
                    showConfirmButton: true,
                    confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á'
                });
                
                this.resetForm();
                Gift.updateGiftButtons(userPoints);
            } else {
                Swal.fire('Error', response.message || 'Failed to save data.', 'error');
            }
        } catch (error) {
            console.error('Error saving data:', error);
            Swal.fire('Error', `Network error: ${error.message}`, 'error');
        } finally {
            this.resetSubmitting();
        }
    },

    resetForm() {
        const foodSearch = document.getElementById('foodSearch');
        if (foodSearch) {
            foodSearch.value = '';
            foodSearch.classList.remove('valid-food', 'invalid-food');
        }
        selectedFood = '';
        
        const statusContainer = document.querySelector('.validation-status');
        if (statusContainer) {
            statusContainer.textContent = '';
        }
    },

    resetSubmitting() {
        isSubmitting = false;
        UI.updateRecordButton('');
    }
};

/* =================================
   üéÅ GIFT/REWARD SYSTEM
   ================================= */
const Gift = {
    async loadGiftData() {
        try {
            const [gifts, userGiftData] = await Promise.all([
                API.getGiftList(),
                liff.getProfile().then(profile => API.getUserDataForGifts(profile.userId))
            ]);

            giftListData = gifts.success ? gifts.gifts : [];
            
            // Merge gift data if needed
            if (userGiftData && userGiftData.success && Array.isArray(userGiftData.data)) {
                userGiftData.data.forEach((value, index) => {
                    if (userData && index < userData.length) {
                        userData[index] = value;
                    }
                });
            }
            
            console.log('Gift data loaded:', giftListData);
            // Don't call updateGiftButtons here - let the caller handle it
            
        } catch (error) {
            console.error('Error loading gift data:', error);
            giftListData = [];
            throw error; // Re-throw to let the caller handle it
        }
    },

    updateGiftButtons(points = userPoints) {
        // Validate required data before proceeding
        if (!giftListData || giftListData.length === 0) {
            console.log('Gift data not ready yet, skipping button update');
            return;
        }
        
        if (!userData || !Array.isArray(userData)) {
            console.log('User data not ready yet, skipping button update');
            return;
        }
        
        if (!validFoodList || validFoodList.length === 0) {
            console.log('Food list not ready yet, skipping button update');
            return;
        }

        console.log('Updating gift buttons with points:', points);

        CONFIG.GIFT_LEVELS.forEach(level => {
            const gift = giftListData.find(g => g.Level === level);
            const button = document.getElementById(`gift${level}`);
            const balanceElement = document.getElementById(`gift${level}-balance`);
            
            if (!button) {
                console.log(`Button gift${level} not found`);
                return;
            }

            // Update balance display
            if (balanceElement && gift) {
                balanceElement.textContent = gift.Balance || 0;
            }

            // Get user status for this gift
            const columnIndex = GIFT_COLUMN_MAP[level];
            const userStatus = userData && columnIndex !== null ? userData[columnIndex] : null;
            const giftBalance = gift ? gift.Balance : 0;

            // Reset button
            button.onclick = null;
            button.classList.remove('btn-available', 'btn-disabled', 'btn-redeemed', 'btn-outofstock');

            // Update button based on status
            this.setButtonState(button, userStatus, points, level, giftBalance);

            console.log(`Gift ${level}: status=${userStatus}, points=${points}, balance=${giftBalance}`);
        });
    },

    setButtonState(button, userStatus, points, level, giftBalance) {
        if (userStatus === 'R') {
            // Already redeemed
            button.textContent = '‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß';
            button.disabled = true;
            button.classList.add('btn-redeemed');
        } else if (userStatus === 'O' || giftBalance <= 0) {
            // Out of stock
            button.textContent = '‡∏Ç‡∏≠‡∏á‡∏´‡∏°‡∏î';
            button.disabled = true;
            button.classList.add('btn-outofstock');
        } else if (points >= level) {
            // Can redeem
            button.textContent = '‡∏Å‡∏î‡∏£‡∏±‡∏ö';
            button.disabled = false;
            button.classList.add('btn-available');
            button.onclick = () => this.redeemGift(level);
        } else {
            // Insufficient points
            button.textContent = '‡∏Å‡∏î‡∏£‡∏±‡∏ö';
            button.disabled = true;
            button.classList.add('btn-disabled');
        }
    },

    async redeemGift(level) {
        if (isSubmitting) {
            console.log('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏≠‡∏¢‡∏π‡πà ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠...');
            return;
        }

        if (userPoints < level) {
            Swal.fire({
                title: '‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠',
                text: `‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ ${level} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ô‡∏µ‡πâ`,
                icon: 'warning',
                confirmButtonColor: '#10b981'
            });
            return;
        }

        const gift = giftListData.find(g => g.Level === level);
        if (!gift || gift.Balance <= 0) {
            Swal.fire({
                title: '‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß',
                text: '‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢ ‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ô‡∏µ‡πâ‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß',
                icon: 'error',
                confirmButtonColor: '#10b981'
            });
            return;
        }

        // Show confirmation
        const result = await Swal.fire({
            title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•',
            html: `
                <div style="text-align: center;">
                    <div style="font-size: 48px; margin-bottom: 15px;">üéÅ</div>
                    <p style="font-size: 18px; font-weight: 600; margin-bottom: 10px;">
                        ‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö <strong style="color: #10b981;">${gift.Gift_Name}</strong>
                    </p>
                    <p style="font-size: 14px; color: #666; margin-top: 15px;">
                        ‡∏Ñ‡∏•‡∏¥‡∏Å "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠
                    </p>
                </div>
            `,
            icon: null,
            showCancelButton: true,
            confirmButtonColor: '#10b981',
            cancelButtonColor: '#6b7280',
            confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö',
            cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
            width: '400px'
        });

        if (result.isConfirmed) {
            await this.processRedeemGift(level);
        }
    },

    async processRedeemGift(level) {
        isSubmitting = true;

        try {
            const profile = await liff.getProfile();
            const uid = profile.userId;
            
            Swal.fire({
                title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•',
                html: `
                    <div style="text-align: center;">
                        <img src="https://raw.githubusercontent.com/HappyWorkPlace/BurnFatForAll/main/picture/giftAnimattion.gif" 
                             alt="loading" style="width:250px;height:250px;">
                        <p style="margin-top: 15px; color: #666; font-size: 16px;">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...</p>
                    </div>
                `,
                showConfirmButton: false,
                allowOutsideClick: false,
                didOpen: () => Swal.showLoading()
            });

            const response = await API.redeemGift(uid, level);
            Swal.close();
            
            if (response.success) {
                await Swal.fire({
                    title: '‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                    html: `
                        <div style="text-align: center;">
                            <img src="https://raw.githubusercontent.com/HappyWorkPlace/BurnFatForAll/main/picture/redeemGIF.gif" 
                                 alt="success" style="width:250px;height:250px;">
                            <p style="margin-top: 15px; font-size: 18px; color: #10b981; font-weight: 600;">
                                üéâ ‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!
                            </p>
                            <p style="margin-top: 10px; font-size: 14px; color: #666;">
                                ‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏¥‡∏ô‡∏î‡∏µ Healthy Life #2
                            </p>
                        </div>
                    `,
                    confirmButtonColor: '#10b981',
                    confirmButtonText: '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£',
                    width: '400px'
                });

                // Redirect to check orders
                window.open('https://liff.line.me/2004752543-O6BZm2yN', '_blank');
                
                // Reload gift data and update buttons
                try {
                    await this.loadGiftData();
                    this.updateGiftButtons(userPoints);
                    console.log('Gift data reloaded after successful redemption');
                } catch (error) {
                    console.error('Error reloading gift data:', error);
                    // Still show success, but log the error
                }
            } else {
                Swal.fire({
                    title: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ',
                    text: response.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á',
                    icon: 'error',
                    confirmButtonColor: '#ef4444'
                });
            }
        } catch (error) {
            console.error('Error redeeming gift:', error);
            Swal.close();
            Swal.fire({
                title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
                text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á',
                icon: 'error',
                confirmButtonColor: '#ef4444'
            });
        } finally {
            isSubmitting = false;
        }
    }
};

/* =================================
   üé® UI FUNCTIONS
   ================================= */
const UI = {
    updateUserAvatar(displayName, pictureUrl) {
        const profileAvatar = document.getElementById('profileAvatar');
        
        if (pictureUrl) {
            profileAvatar.innerHTML = `<img src="${pictureUrl}" alt="${displayName}" class="profile-image">`;
        } else {
            const initials = displayName.substring(0, 2).toUpperCase();
            profileAvatar.innerHTML = initials;
        }
    },

    updateUserInfo(displayName, parsedData) {
        document.getElementById('memberName').textContent = displayName;
        const deptText = parsedData.Name && parsedData.Division 
            ? `${parsedData.Name}<br>${parsedData.Division}` 
            : (parsedData.Name || parsedData.Division || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏');
        document.getElementById('memberDept').innerHTML = deptText;
        document.getElementById('memberBadge').textContent = parsedData.Factory || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô';
    },

    updatePointsDisplay(points) {
        document.getElementById('pointsValue').textContent = points;
        
        const progressPercent = Utils.calculateProgress(points);
        document.getElementById('progressFill').style.width = progressPercent + '%';
        
        // Update milestone states
        const milestones = document.querySelectorAll('.milestone');
        milestones.forEach((milestone, index) => {
            const milestoneValue = CONFIG.MILESTONE_VALUES[index];
            milestone.classList.remove('achieved', 'current');
            
            if (points >= milestoneValue) {
                milestone.classList.add('achieved');
            } else if (index === 0 && points >= 0 && points < milestoneValue) {
                milestone.classList.add('current');
            } else if (index > 0 && points >= CONFIG.MILESTONE_VALUES[index - 1] && points < milestoneValue) {
                milestone.classList.add('current');
            }
        });

        // Only update gift buttons if all required data is ready
        if (giftListData && giftListData.length > 0 && 
            userData && Array.isArray(userData) && 
            validFoodList && validFoodList.length > 0) {
            Gift.updateGiftButtons(points);
        } else {
            console.log('Skipping gift button update - data not ready yet');
        }
    },

    updateValidationStatus(inputElement, validation) {
        let statusContainer = inputElement.parentElement.querySelector('.validation-status');
        if (!statusContainer) {
            statusContainer = document.createElement('div');
            statusContainer.className = 'validation-status';
            inputElement.parentElement.appendChild(statusContainer);
        }

        inputElement.classList.remove('valid-food', 'invalid-food');
        
        if (validation.showIcon) {
            if (validation.isValid) {
                inputElement.classList.add('valid-food');
                statusContainer.style.color = '#4CAF50';
                statusContainer.textContent = validation.message;
            } else {
                inputElement.classList.add('invalid-food');
                statusContainer.style.color = '#f44336';
                statusContainer.textContent = validation.message;
            }
        } else {
            statusContainer.textContent = '';
        }
    },

    updateRecordButton(food) {
        const button = document.getElementById('recordBtn');
        if (!button) return;
        
        const validation = Food.validateFood(food);
        
        if (validation.isValid && !isSubmitting) {
            button.disabled = false;
            button.innerHTML = '<i class="fas fa-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏ó‡∏≤‡∏ô';
            selectedFood = food.trim();
        } else {
            button.disabled = true;
            if (isSubmitting) {
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
            } else if (food && food.trim() !== '') {
                button.innerHTML = '<i class="fas fa-exclamation-triangle"></i> ‡πÄ‡∏°‡∏ô‡∏π‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
            } else {
                button.innerHTML = '<i class="fas fa-save"></i> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏°‡∏ô‡∏π‡∏Å‡πà‡∏≠‡∏ô';
            }
            selectedFood = '';
        }

        const foodInput = document.getElementById('foodSearch');
        if (foodInput) {
            this.updateValidationStatus(foodInput, validation);
        }
    },

    hideLoadingScreen() {
        const loadingScreen = document.getElementById('loadingScreen');
        if (loadingScreen) {
            loadingScreen.style.opacity = '0';
            setTimeout(() => {
                loadingScreen.style.display = 'none';
            }, 300);
        }
    },

    showErrorAndHideLoading(message) {
        this.hideLoadingScreen();
        
        Swal.fire({
            title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
            text: message,
            icon: 'error',
            confirmButtonText: '‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö',
            confirmButtonColor: '#ef4444'
        });
    },

    // Carousel functions
    startAutoScroll() {
        const totalGifts = 5;
        
        autoScrollInterval = setInterval(() => {
            if (!userInteracted) {
                currentGiftIndex = (currentGiftIndex + 1) % totalGifts;
                this.scrollToGift(currentGiftIndex);
            }
        }, CONFIG.AUTO_SCROLL_INTERVAL);
    },

    stopAutoScroll() {
        if (autoScrollInterval) {
            clearInterval(autoScrollInterval);
            userInteracted = true;
            setTimeout(() => {
                userInteracted = false;
                this.startAutoScroll();
            }, 10000);
        }
    },

    scrollToGift(index) {
        const container = document.getElementById('giftsContainer');
        if (!container || !container.children[0]) return;
        
        const giftWidth = container.children[0].offsetWidth;
        container.scrollTo({
            left: giftWidth * index,
            behavior: 'smooth'
        });
        this.updateIndicators(index);
        currentGiftIndex = index;
        this.stopAutoScroll();
    },

    updateIndicators(activeIndex) {
        const indicators = document.querySelectorAll('.indicator-dot');
        indicators.forEach((indicator, index) => {
            indicator.classList.toggle('active', index === activeIndex);
        });
    }
};
/* =================================
   üìã HISTORY MANAGEMENT
   ================================= */
const History = {
    async loadHistory() {
        const loading = document.getElementById('historyLoading');
        const list = document.getElementById('historyList');
        
        loading.style.display = 'block';
        list.style.display = 'none';
        
        if (!userData || !Array.isArray(userData) || userData.length === 0) {
            console.error('User data not available for history');
            loading.style.display = 'none';
            list.style.display = 'block';
            this.showErrorHistory();
            return;
        }
        
        const userId = userData[0];
        
        if (!userId) {
            console.error('User ID not found in userData');
            loading.style.display = 'none';
            list.style.display = 'block';
            this.showErrorHistory();
            return;
        }
        
        try {
            const response = await API.getUserRecords(userId);
            loading.style.display = 'none';
            list.style.display = 'block';
            
            if (response.success && response.records && response.records.length > 0) {
                // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏°‡∏≤‡πÅ‡∏£‡∏Å‡∏™‡∏∏‡∏î
                historyData = response.records.reverse();
                currentPage = 1;
                this.displayHistory();
            } else {
                this.showEmptyHistory();
            }
        } catch (error) {
            console.error('Error loading history:', error);
            loading.style.display = 'none';
            list.style.display = 'block';
            this.showErrorHistory();
        }
    },

    displayHistory() {
        const list = document.getElementById('historyList');
        
        const startIndex = (currentPage - 1) * CONFIG.RECORDS_PER_PAGE;
        const endIndex = startIndex + CONFIG.RECORDS_PER_PAGE;
        const pageRecords = historyData.slice(startIndex, endIndex);
        
        // Create header with record count
        const totalRecords = historyData.length;
        const headerHTML = `
            <div class="history-header">
                <div class="history-title">
                    <i class="fas fa-clock"></i>
                    ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                </div>
            </div>
        `;
        
        let historyHTML = '';
        
        pageRecords.forEach((record, index) => {
            const dateTime = Utils.formatDateTime(record.TimeStamp);
            const menu = record.Menu || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏°‡∏ô‡∏π';
            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≤‡∏Å‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏°‡∏≤‡πÅ‡∏£‡∏Å‡∏™‡∏∏‡∏î
            const recordNumber = totalRecords - (startIndex + index);
            
            historyHTML += `
                <div class="history-item">
                    <div class="history-date">
                        <i class="fas fa-calendar-alt"></i>
                        ${dateTime} ‚Ä¢ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà ${recordNumber}
                    </div>
                    <div class="history-food">${menu}</div>
                </div>
            `;
        });
        
        const totalPages = Math.ceil(historyData.length / CONFIG.RECORDS_PER_PAGE);
        const paginationHTML = this.createPagination(currentPage, totalPages);
        
        list.innerHTML = headerHTML + historyHTML + paginationHTML;
    },

    createPagination(current, total) {
        if (total <= 1) return '';
        
        let html = '<div class="pagination-container">';
        
        // Previous button
        if (current > 1) {
            html += `
                <button class="pagination-btn" onclick="History.changePage(${current - 1})">
                    <i class="fas fa-chevron-left"></i>
                    ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤
                </button>
            `;
        }
        
        // Page info
        html += `
            <div class="pagination-info">
                ‡∏´‡∏ô‡πâ‡∏≤ ${current} ‡∏à‡∏≤‡∏Å ${total}
            </div>
        `;
        
        // Next button
        if (current < total) {
            html += `
                <button class="pagination-btn" onclick="History.changePage(${current + 1})">
                    ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
                    <i class="fas fa-chevron-right"></i>
                </button>
            `;
        }
        
        html += '</div>';
        return html;
    },

    changePage(page) {
        currentPage = page;
        this.displayHistory();
        
        // Smooth scroll to top of history section
        const historySection = document.getElementById('historySection');
        if (historySection) {
            historySection.scrollIntoView({ 
                behavior: 'smooth', 
                block: 'start' 
            });
        }
        
        // Add visual feedback
        const paginationContainer = document.querySelector('.pagination-container');
        if (paginationContainer) {
            paginationContainer.style.transform = 'scale(0.95)';
            setTimeout(() => {
                paginationContainer.style.transform = 'scale(1)';
            }, 150);
        }
    },

    showEmptyHistory() {
        const list = document.getElementById('historyList');
        list.innerHTML = `
            <div class="empty-history">
                <div class="empty-state-content">
                    <div class="icon">üìù</div>
                    <h3>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</h3>
                    <p>‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢!</p>
                    <button class="retry-btn" onclick="Navigation.switchTab('record')">
                        <i class="fas fa-utensils"></i>
                        ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                    </button>
                </div>
            </div>
        `;
    },

    showErrorHistory() {
        const list = document.getElementById('historyList');
        list.innerHTML = `
            <div class="error-history">
                <div class="error-state-content">
                    <div class="icon">‚ö†Ô∏è</div>
                    <h3>‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÑ‡∏î‡πâ</h3>
                    <p>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠<br>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï‡πÅ‡∏•‡∏∞‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</p>
                    <button class="retry-btn" onclick="History.loadHistory()">
                        <i class="fas fa-redo-alt"></i>
                        ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà
                    </button>
                </div>
            </div>
        `;
    },

    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö refresh ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    async refreshHistory() {
        const list = document.getElementById('historyList');
        
        // ‡πÅ‡∏™‡∏î‡∏á loading overlay
        const loadingOverlay = document.createElement('div');
        loadingOverlay.innerHTML = `
            <div class="history-loading">
                <div class="spinner"></div>
                <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
            </div>
        `;
        loadingOverlay.style.position = 'absolute';
        loadingOverlay.style.top = '0';
        loadingOverlay.style.left = '0';
        loadingOverlay.style.right = '0';
        loadingOverlay.style.bottom = '0';
        loadingOverlay.style.background = 'rgba(255, 255, 255, 0.9)';
        loadingOverlay.style.zIndex = '10';
        loadingOverlay.style.borderRadius = 'var(--radius-lg)';
        
        const container = list.parentElement;
        container.style.position = 'relative';
        container.appendChild(loadingOverlay);
        
        try {
            await this.loadHistory();
        } finally {
            container.removeChild(loadingOverlay);
        }
    }
};

/* =================================
   üéõÔ∏è EVENT LISTENERS & NAVIGATION
   ================================= */
const Navigation = {
    switchTab(tabName) {
        // Update nav tabs
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        event.target.closest('.nav-tab').classList.add('active');

        // Update sections
        document.querySelectorAll('.section').forEach(section => {
            section.classList.remove('active');
        });
        
        const targetSection = document.getElementById(tabName + 'Section');
        if (targetSection) {
            targetSection.classList.add('active');
        }

        if (tabName === 'history') {
            History.loadHistory();
        }
    },

    setupEventListeners() {
        // Food search
        const foodSearch = document.getElementById('foodSearch');
        if (foodSearch) {
            foodSearch.addEventListener('input', function() {
                const value = this.value;
                const dropdown = document.getElementById('foodDropdown');
                
                if (value.length > 0) {
                    dropdown.style.display = 'block';
                    const items = dropdown.querySelectorAll('.dropdown-item');
                    let hasVisibleItems = false;
                    
                    items.forEach(item => {
                        const foodName = item.textContent;
                        if (foodName.toLowerCase().includes(value.toLowerCase())) {
                            item.style.display = 'block';
                            item.innerHTML = Utils.highlightText(foodName, value);
                            hasVisibleItems = true;
                        } else {
                            item.style.display = 'none';
                        }
                    });
                    
                    if (!hasVisibleItems) {
                        dropdown.style.display = 'none';
                    }
                } else {
                    dropdown.style.display = 'none';
                }

                UI.updateRecordButton(value);
            });
        }

        // Dropdown selection
        const foodDropdown = document.getElementById('foodDropdown');
        if (foodDropdown) {
            foodDropdown.addEventListener('click', function(e) {
                if (e.target.classList.contains('dropdown-item')) {
                    const searchInput = document.getElementById('foodSearch');
                    const selectedText = e.target.textContent;
                    
                    searchInput.value = selectedText;
                    selectedFood = selectedText;
                    this.style.display = 'none';
                    UI.updateRecordButton(selectedFood);
                    searchInput.focus();
                }
            });
        }

        // Click outside dropdown
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.search-container')) {
                document.getElementById('foodDropdown').style.display = 'none';
            }
        });

        // Record button
        const recordBtn = document.getElementById('recordBtn');
        if (recordBtn) {
            recordBtn.addEventListener('click', function() {
                if (selectedFood && !isSubmitting) {
                    Food.recordSelection();
                }
            });
        }

        // Carousel scroll handling
        const giftsContainer = document.getElementById('giftsContainer');
        if (giftsContainer) {
            giftsContainer.addEventListener('scroll', function() {
                const container = this;
                const giftWidth = container.children[0]?.offsetWidth || 0;
                const scrollLeft = container.scrollLeft;
                const activeIndex = Math.round(scrollLeft / giftWidth);
                UI.updateIndicators(activeIndex);
                currentGiftIndex = activeIndex;
            });

            // Stop auto-scroll on user interaction
            giftsContainer.addEventListener('touchstart', UI.stopAutoScroll);
            giftsContainer.addEventListener('mousedown', UI.stopAutoScroll);
        }
    }
};

/* =================================
   üöÄ INITIALIZATION
   ================================= */
const App = {
    async initialize() {
        console.log('üöÄ App initializing...');
        
        try {
            // Setup event listeners first
            console.log('üìã Setting up event listeners...');
            Navigation.setupEventListeners();
            
            // Initialize LIFF
            console.log('üì± Initializing LIFF...');
            await LIFF.initialize();
            
            console.log('‚úÖ App initialized successfully');
        } catch (error) {
            console.error('‚ùå App initialization failed:', error);
            UI.showErrorAndHideLoading('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏≠‡∏õ‡πÑ‡∏î‡πâ');
        }
    },

    // Recovery method for when things go wrong
    async recover() {
        console.log('üîÑ Attempting to recover app state...');
        
        try {
            if (Utils.isDataReady()) {
                console.log('Data is ready, updating UI...');
                Gift.updateGiftButtons(userPoints);
                UI.startAutoScroll();
                return true;
            } else {
                console.log('Data not ready, attempting reload...');
                if (userData && userData.length > 0) {
                    await User.loadInitialData();
                    return true;
                }
            }
        } catch (error) {
            console.error('Recovery failed:', error);
        }
        
        return false;
    }
};

// Global functions for HTML onclick handlers
window.switchTab = Navigation.switchTab.bind(Navigation);
window.scrollToGift = UI.scrollToGift.bind(UI);
window.History = History;
window.App = App; // Make App available globally for debugging

// Initialize when DOM is ready
document.addEventListener('DOMContentLoaded', App.initialize);
window.addEventListener('load', () => {
    // Fallback initialization if DOMContentLoaded didn't work
    if (!document.querySelector('.app-container')) {
        console.log('üîÑ Fallback initialization triggered');
        App.initialize();
    }
});

// Add error recovery on window error
window.addEventListener('error', (event) => {
    console.error('üí• Window error:', event.error);
    
    // Try to recover after a short delay
    setTimeout(() => {
        if (window.App && typeof window.App.recover === 'function') {
            console.log('üîß Attempting automatic recovery...');
            window.App.recover();
        }
    }, 2000);
});
</script>

</body>
</html>
