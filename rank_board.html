<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Redeem Rewards</title>
    <link href="https://fonts.googleapis.com/css?family=Kanit&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Kanit', sans-serif;
            background-color: #f3f4f6;
            margin: 0;
            padding: 0;
            display: block; /* เปลี่ยนจาก flex เป็น block */
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden; /* ป้องกันการเลื่อนถ้า content ใหญ่กว่าจอ */
        }
        .container {
            position: relative;
            width: 400px;
            height: 800px;
            background-image: url('https://raw.githubusercontent.com/HappyWorkPlace/BurnFatForAll/main/picture/Gift_NewDesign.png');
            background-size: cover;
            background-position: center;
            margin: 0 auto; /* ให้ container อยู่ตรงกลางหน้าจอ */
        }
        .reward-info, .reward-image {
            position: absolute;
            text-align: center;
        }
        .reward-info {
            background-color: rgba(255, 255, 255, 0.7);
            padding: 3px;
            border-radius: 8px;
            width: 150px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .reward-info p {
            margin: 3px 0;
            font-size: 0.8em;
        }
        .reward-image img {
            width: 70px; /* ปรับขนาดได้ตามต้องการ */
            height: auto;
            transition: filter 0.3s;
            cursor: pointer;
        }
        .reward-image.disabled img {
            filter: grayscale(100%);
            cursor: not-allowed;
        }
        .click-animation {
            position: absolute;
            width: 50px; /* ขนาดของภาพ GIF */
            height: 50px; /* ขนาดของภาพ GIF */
            top:20px;
            right: -30px; 
            display: none; /* ซ่อนโดยเริ่มต้น */
        }
        .speech-bubble {
            position: absolute;
            top: 30px;
            left: 120px;
            border-radius: 5px;
            padding: 10px;
            font-size: 1em;
            width: 200px;
        }
        .speech-bubble .score {
            color: blue;
            font-weight: bold;
            font-size: 1.2em;
            top: 30px;
            left: 120px;
        }
        /* ปรับตำแหน่งให้เข้ากับดีไซน์ */
        .reward1-image { top: 100px; left: 250px; }
        .reward2-image { top: 220px; left: 130px; }
        .reward3-image { top: 330px; left: 250px; }
        .reward4-image { top: 420px; left: 130px; }
        .reward5-image { top: 535px; left: 245px; }
        .reward6-image { top: 630px; left: 125px; }
        
        .reward1-info { top: 120px; left: 60px; }
        .reward2-info { top: 220px; left: 230px; }
        .reward3-info { top: 320px; left: 60px; }
        .reward4-info { top: 430px; left: 230px; }
        .reward5-info { top: 530px; left: 60px; }
        .reward6-info { top: 630px ;left: 230px; }
    </style>
</head>
<body>
    <div class="container">
        <!-- กล่องข้อความของหมี -->
        <div class="speech-bubble">
            <span class="score" id="points-value">รอสักครู่...</span>
        </div>

        <!-- ของรางวัลต่างๆ -->
        <div class="reward-image reward1-image" id="gift15-image">
            <img src="https://raw.githubusercontent.com/HappyWorkPlace/BurnFatForAll/main/picture/15.png" alt="ทิชชู่คุมะ" onclick="redeemGift(15)">
            <img src="https://raw.githubusercontent.com/HappyWorkPlace/BurnFatForAll/main/picture/click_animation.gif" class="click-animation" id="gift15-animation">
        </div>
        <div class="reward-info reward1-info">
            <p><strong>ทิชชู่คุมะ</strong></p>
            <p>สะสมคะแนนครบ: 15</p>
            <p>จำนวนคงเหลือ: <span id="gift15-balance">-</span></p>
        </div>

        <div class="reward-image reward2-image" id="gift30-image">
            <img src="https://raw.githubusercontent.com/HappyWorkPlace/BurnFatForAll/main/picture/30.png" alt="ขวดน้ำ Doraemon" onclick="redeemGift(30)">
            <img src="https://raw.githubusercontent.com/HappyWorkPlace/BurnFatForAll/main/picture/click_animation.gif" class="click-animation" id="gift30-animation">
        </div>
        <div class="reward-info reward2-info">
            <p><strong>ขวดน้ำ Doraemon</strong></p>
            <p>สะสมคะแนนครบ: 30</p>
            <p>จำนวนคงเหลือ: <span id="gift30-balance">-</span></p>
        </div>

        <div class="reward-image reward3-image" id="gift45-image">
            <img src="https://raw.githubusercontent.com/HappyWorkPlace/BurnFatForAll/main/picture/45.png" alt="กล่องอาหาร Super lock" onclick="redeemGift(45)">
            <img src="https://raw.githubusercontent.com/HappyWorkPlace/BurnFatForAll/main/picture/click_animation.gif" class="click-animation" id="gift45-animation">
        </div>
        <div class="reward-info reward3-info">
            <p><strong>กล่องอาหาร Super lock</strong></p>
            <p>สะสมคะแนนครบ: 45</p>
            <p>จำนวนคงเหลือ: <span id="gift45-balance">-</span></p>
        </div>

        <div class="reward-image reward4-image" id="gift60-image">
            <img src="https://raw.githubusercontent.com/HappyWorkPlace/BurnFatForAll/main/picture/60.png" alt="กระเป๋า" onclick="redeemGift(60)">
            <img src="https://raw.githubusercontent.com/HappyWorkPlace/BurnFatForAll/main/picture/click_animation.gif" class="click-animation" id="gift60-animation">
        </div>
        <div class="reward-info reward4-info">
            <p><strong>กระเป๋า</strong></p>
            <p>สะสมคะแนนครบ: 60</p>
            <p>จำนวนคงเหลือ: <span id="gift60-balance">-</span></p>
        </div>

        <div class="reward-image reward5-image" id="gift75-image">
            <img src="https://raw.githubusercontent.com/HappyWorkPlace/BurnFatForAll/main/picture/75.png" alt="แก้ว LocknLock" onclick="redeemGift(75)">
            <img src="https://raw.githubusercontent.com/HappyWorkPlace/BurnFatForAll/main/picture/click_animation.gif" class="click-animation" id="gift75-animation">
        </div>
        <div class="reward-info reward5-info">
            <p><strong>แก้ว LocknLock</strong></p>
            <p>สะสมคะแนนครบ: 75</p>
            <p>จำนวนคงเหลือ: <span id="gift75-balance">-</span></p>
        </div>

        <div class="reward-image reward6-image" id="gift90-image">
            <img src="https://raw.githubusercontent.com/HappyWorkPlace/BurnFatForAll/main/picture/90.png" alt="หมวก MGH" onclick="redeemGift(90)">
            <img src="https://raw.githubusercontent.com/HappyWorkPlace/BurnFatForAll/main/picture/click_animation.gif" class="click-animation" id="gift90-animation">
        </div>
        <div class="reward-info reward6-info">
            <p><strong>หมวก MGH</strong></p>
            <p>สะสมคะแนนครบ: 90</p>
            <p>จำนวนคงเหลือ: <span id="gift90-balance">-</span></p>
        </div>
    </div>

    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
document.addEventListener('DOMContentLoaded', function () {
    initializeLiff('2004752543-ao4VyADR'); 
});

function initializeLiff(myLiffId) {
    liff.init({
        liffId: myLiffId
    }).then(() => {
        if (liff.isLoggedIn()) {
            liff.getProfile().then(profile => {
                const uid = profile.userId;
                fetchDataAndUpdateUI(uid);
            }).catch(err => {
                console.error('Failed to get profile:', err);
                document.getElementById('points-value').innerText = 'ไม่สามารถดึงคะแนนของผู้ใช้ได้';
            });
        } else {
            liff.login();
        }
    }).catch(err => {
        console.error('LIFF initialization failed', err);
        document.getElementById('gift-container').innerText = 'ไม่สามารถดึงข้อมูลของขวัญได้';
    });
}

function disableAllRewardImages() {
    const images = document.querySelectorAll('.reward-image');
    images.forEach(image => {
        image.classList.add('disabled');
        image.querySelector('img').onclick = null; // Remove the click event
        const animation = image.querySelector('.click-animation');
        if (animation) {
            animation.style.display = 'none'; // ซ่อนภาพเคลื่อนไหว
        }
    });
}

function fetchDataAndUpdateUI(uid) {
    disableAllRewardImages(); // Disable all images initially

    Promise.all([fetchUserData(uid), fetchGiftList()])
        .then(([userData, gifts]) => {
            const points = userData[5]; // Assuming points is at index 5
            displayPoints(points);
            updateRewardImages(userData, gifts, points);
        }).catch(err => {
            console.error('Error fetching data:', err);
            document.getElementById('points-value').innerText = 'กรุณาลงทะเบียนก่อน';
        });
}


function fetchUserData(uid) {
    return fetch(`https://script.google.com/macros/s/AKfycbz5i0Xp6HXqm9gmnraGzkgFoQOLY2ub6qEthUOFRn7yoLabUd3vkfl2VimiEqar_W8/exec?action=getUserData&uid=${uid}`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            console.log(data); // ตรวจสอบข้อมูลที่ได้รับ
            if (data.success) {
                return data.data;
            } else {
                throw new Error('Error fetching user data');
            }
        });
}

function fetchGiftList() {
    return fetch(`https://script.google.com/macros/s/AKfycbz5i0Xp6HXqm9gmnraGzkgFoQOLY2ub6qEthUOFRn7yoLabUd3vkfl2VimiEqar_W8/exec?action=getGiftList`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            console.log(data); // ตรวจสอบข้อมูลที่ได้รับ
            if (data.success) {
                return data.gifts;
            } else {
                throw new Error('Error fetching gift list');
            }
        });
}

function updateRewardImages(userData, gifts, points) {
    gifts.forEach(gift => {
        const image = document.getElementById(`gift${gift.Level}-image`);
        const animation = document.getElementById(`gift${gift.Level}-animation`);
        const balanceElement = document.getElementById(`gift${gift.Level}-balance`);
        const columnIndex = getColumnIndexByLevel(gift.Level); 
        const userGiftStatus = userData[columnIndex]; 

        console.log(`Gift Level: ${gift.Level}, Status: ${userGiftStatus}, Balance: ${gift.Balance}`);

        if (balanceElement) {
            balanceElement.innerText = gift.Balance;
        }

        if (image) {
            if (userGiftStatus === 'R') {
                image.classList.add('disabled');
                image.querySelector('img').onclick = null; // Remove the click event
                if (animation) animation.style.display = 'none'; // Hide animation
            } else if (userGiftStatus === 'O' || gift.Balance <= 0) {
                image.classList.add('disabled');
                image.querySelector('img').onclick = null; // Remove the click event
                if (animation) animation.style.display = 'none'; // Hide animation
            } else if (userGiftStatus === 'Y') {
                image.classList.remove('disabled');
                image.querySelector('img').onclick = () => redeemGift(gift.Level);
                if (animation) animation.style.display = 'block'; // Show animation
            } else {
                image.classList.add('disabled');
                image.querySelector('img').onclick = null; // Remove the click event
                if (animation) animation.style.display = 'none'; // Hide animation
            }
        }
    });
}

function getColumnIndexByLevel(level) {
    switch (level) {
        case 15:
            return 6; // Column G
        case 30:
            return 7; // Column H
        case 45:
            return 8; // Column I
        case 60:
            return 9; // Column J
        case 75:
            return 10; // Column K
        case 90:
            return 11; // Column L
        default:
            return null;
    }
}

function redeemGift(level) {
    liff.getProfile().then(profile => {
        const uid = profile.userId;
        Swal.fire({
            title: 'กำลังจองของรางวัล',
            html: '<img src="https://raw.githubusercontent.com/HappyWorkPlace/BurnFatForAll/main/picture/giftAnimattion.gif" alt="loading" style="width:300px;height:300px;"><p>กรุณารอสักครู่...</p>',
            showConfirmButton: false,
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
                fetch(`https://script.google.com/macros/s/AKfycbz5i0Xp6HXqm9gmnraGzkgFoQOLY2ub6qEthUOFRn7yoLabUd3vkfl2VimiEqar_W8/exec?action=redeemGift&uid=${uid}&level=${level}`)
                    .then(response => response.json())
                    .then(data => {
                        Swal.close();
                        if (data.success) {
                            Swal.fire({
                                title: 'สำเร็จ',
                                html: '<img src="https://raw.githubusercontent.com/HappyWorkPlace/BurnFatForAll/main/picture/redeemGIF.gif" alt="success" style="width:300px;height:300px;"><p>แลกรับรางวัลเรียบร้อยแล้ว</p>'
                            }).then(() => {
                                document.body.innerHTML = `
                                    <div style="text-align: center;">
                                        <p style="font-weight: bold; color: blue;">บันทึกข้อมูลเรียบร้อยแล้ว</p>
                                        <p>คุณสามารถตรวจสอบได้ที่ <a href="https://liff.line.me/2004752543-O6BZm2yN" target="_blank">Link</a></p>
                                    </div>
                                `;
                            });
                        } else {
                            Swal.fire('ผิดพลาด', data.message, 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Error redeeming gift:', error);
                        Swal.close();
                        Swal.fire('ผิดพลาด', 'ไม่สามารถรับของรางวัลได้', 'error');
                    });
            }
        });
    });
}

function displayPoints(points) {
    const pointsElement = document.getElementById('points-value');
    if (pointsElement) {
        pointsElement.innerText = points;
    } else {
        console.error('Points element not found');
    }
}
    </script>
</body>
</html>
